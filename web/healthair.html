<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAir - KI Gesundheits-Assistent</title>
    <meta name="description" content="Personalisierte Gesundheitsprognosen basierend auf Luftqualit√§t, Wetter und Umweltfaktoren. F√ºr Asthma, Allergien, Migr√§ne und mehr.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-dim: #64748b;
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
            --gradient: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        
        /* Language Bar */
        .lang-bar {
            background: #1e293b;
            padding: 8px 16px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
        }
        .lang-bar select {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .lang-bar select option { color: #1e293b; }
        
        /* Header */
        header {
            background: var(--gradient);
            color: white;
            padding: 24px 16px;
            text-align: center;
        }
        .logo { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
        .logo span { opacity: 0.9; }
        .tagline { font-size: 0.95rem; opacity: 0.9; }
        
        /* Health Profile Setup */
        .profile-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin: -30px 16px 16px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            z-index: 10;
        }
        .profile-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        .condition-btn {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.85rem;
            font-weight: 500;
        }
        .condition-btn:hover { border-color: var(--primary); }
        .condition-btn.selected {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-dark);
        }
        .condition-btn .icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        
        .location-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .location-input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            background: var(--bg);
        }
        .location-input:focus { outline: none; border-color: var(--primary); }
        
        .time-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
            margin-bottom: 16px;
        }
        .time-label {
            font-size: 0.85rem;
            color: var(--text-dim);
            font-weight: 500;
        }
        .time-select {
            padding: 10px 14px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.85rem;
            background: var(--bg);
            cursor: pointer;
        }
        .time-select:focus { outline: none; border-color: var(--primary); }
        
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .btn-primary {
            background: var(--gradient);
            color: white;
        }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(14,165,233,0.3); }
        .btn-secondary {
            background: var(--bg);
            color: var(--text);
            border: 2px solid var(--border);
        }
        
        /* Risk Summary */
        .risk-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }
        .risk-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            flex-wrap: wrap;
            gap: 8px;
        }
        .risk-title { font-size: 1.1rem; font-weight: 600; }
        .risk-subtitle { font-size: 0.85rem; color: var(--text-dim); }
        .risk-badge {
            padding: 6px 16px;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.85rem;
        }
        .risk-low { background: #d1fae5; color: #065f46; }
        .risk-medium { background: #fef3c7; color: #92400e; }
        .risk-high { background: #fee2e2; color: #991b1b; }
        .risk-critical { background: #fecaca; color: #7f1d1d; }
        
        .symptom-forecast {
            background: linear-gradient(135deg, rgba(14,165,233,0.05), rgba(139,92,246,0.05));
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .forecast-text {
            font-size: 1.05rem;
            line-height: 1.7;
            color: var(--text);
        }
        .forecast-highlight {
            background: rgba(239,68,68,0.1);
            color: var(--danger);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        .forecast-good {
            background: rgba(16,185,129,0.1);
            color: var(--success);
            padding: 2px 8px;
            border-radius: 6px;
            font-weight: 600;
        }
        
        /* Hourly Timeline */
        .timeline-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }
        .timeline-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .timeline-scroll {
            display: flex;
            gap: 12px;
            overflow-x: auto;
            padding-bottom: 8px;
        }
        .hour-block {
            flex-shrink: 0;
            width: 70px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 12px;
            background: var(--bg);
            border: 2px solid transparent;
        }
        .hour-block.warning { border-color: var(--warning); background: #fffbeb; }
        .hour-block.danger { border-color: var(--danger); background: #fef2f2; }
        .hour-time { font-size: 0.75rem; color: var(--text-dim); font-weight: 500; }
        .hour-date { font-size: 0.65rem; color: var(--text-dim); }
        .hour-risk { font-size: 1.5rem; margin: 6px 0; }
        .hour-label { font-size: 0.65rem; color: var(--text-dim); }
        
        /* Trigger Cards */
        .triggers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .trigger-card {
            background: var(--card);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.04);
        }
        .trigger-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        .trigger-icon { font-size: 1.2rem; }
        .trigger-title { font-size: 0.8rem; font-weight: 600; color: var(--text-dim); }
        .trigger-value { font-size: 1.4rem; font-weight: 700; }
        .trigger-status {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 8px;
        }
        .status-good { background: #d1fae5; color: #065f46; }
        .status-moderate { background: #fef3c7; color: #92400e; }
        .status-bad { background: #fee2e2; color: #991b1b; }
        .trigger-detail { font-size: 0.75rem; color: var(--text-dim); margin-top: 4px; }
        
        /* Chat */
        .chat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.04);
        }
        .chat-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .chat-messages {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: var(--bg);
            border-radius: 12px;
            min-height: 60px;
        }
        .chat-msg {
            padding: 10px 14px;
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .chat-user {
            background: var(--primary);
            color: white;
            margin-left: 25%;
            text-align: right;
        }
        .chat-ai {
            background: white;
            border: 1px solid var(--border);
            margin-right: 15%;
        }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 24px;
            font-size: 0.9rem;
        }
        .chat-input:focus { outline: none; border-color: var(--primary); }
        .chat-send {
            padding: 12px 20px;
            border-radius: 24px;
            background: var(--gradient);
            color: white;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Quick Actions */
        .quick-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .quick-btn {
            padding: 8px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* Tips */
        .tips-card {
            background: linear-gradient(135deg, #ecfdf5, #f0fdf4);
            border: 1px solid #86efac;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
        }
        .tips-title {
            font-size: 1rem;
            font-weight: 600;
            color: #166534;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .tip-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px 0;
            font-size: 0.9rem;
            color: #166534;
        }
        .tip-icon { font-size: 1.1rem; }
        
        /* Premium Banner */
        .premium-banner {
            background: var(--gradient);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            margin-bottom: 16px;
        }
        .premium-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 8px; }
        .premium-features { font-size: 0.85rem; opacity: 0.9; margin-bottom: 12px; }
        .premium-btn {
            background: white;
            color: var(--primary-dark);
            padding: 10px 24px;
            border-radius: 24px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Loading */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-dim);
        }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        footer {
            text-align: center;
            padding: 24px;
            color: var(--text-dim);
            font-size: 0.8rem;
        }
        footer a { color: var(--primary); text-decoration: none; }
        
        @media (max-width: 600px) {
            .triggers-grid { grid-template-columns: 1fr; }
            .condition-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <!-- Language Bar -->
    <div class="lang-bar">
        <select id="language" onchange="changeLanguage()">
            <option value="de">üá©üá™ Deutsch</option>
            <option value="en">üá¨üáß English</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
            <option value="it">üáÆüáπ Italiano</option>
        </select>
    </div>

    <header>
        <div class="logo">ü´Å Health<span>Air</span></div>
        <div class="tagline" id="tagline">Personalisierte Gesundheitsprognosen ‚Ä¢ KI-gest√ºtzt</div>
    </header>
    
    <div class="container">
        <!-- Health Profile -->
        <div class="profile-card">
            <div class="profile-title">üë§ <span id="profileTitle">Mein Gesundheitsprofil</span></div>
            <div class="condition-grid" id="conditions"></div>
            
            <div class="location-row">
                <input type="text" class="location-input" id="location" placeholder="Ort eingeben (z.B. Z√ºrich, Schweiz)">
                <button class="btn btn-secondary" onclick="useGPS()">üìç GPS</button>
            </div>
            
            <div class="time-row">
                <span class="time-label" id="timeLabel">‚è∞ Zeitraum:</span>
                <select class="time-select" id="timeRange">
                    <option value="6">6 Stunden</option>
                    <option value="12" selected>12 Stunden</option>
                    <option value="24">24 Stunden</option>
                    <option value="48">48 Stunden</option>
                    <option value="72">3 Tage</option>
                </select>
                <div style="flex:1;"></div>
                <button class="btn btn-primary" onclick="analyze()" id="btnAnalyze">Analysieren</button>
            </div>
        </div>
        
        <!-- Main Content -->
        <div id="main-content">
            <div class="loading">
                <div class="loading-spinner"></div>
                <p id="initialMsg">W√§hle deine Gesundheitsbedingungen und klicke auf "Analysieren"</p>
            </div>
        </div>
    </div>

    <script>
        const API = 'https://space-ai-alert-mvp.onrender.com';
        let selectedConditions = [];
        let lat = 47.3769, lon = 8.5417;
        let locationName = '';
        let chatHistory = [];
        let currentData = null;
        let currentLang = 'de';
        
        // === TRANSLATIONS ===
        const T = {
            de: {
                tagline: "Personalisierte Gesundheitsprognosen ‚Ä¢ KI-gest√ºtzt",
                profileTitle: "Mein Gesundheitsprofil",
                locationPlaceholder: "Ort eingeben (z.B. Z√ºrich, Schweiz)",
                timeLabel: "‚è∞ Zeitraum:",
                btnAnalyze: "Analysieren",
                initialMsg: "W√§hle deine Gesundheitsbedingungen und klicke auf \"Analysieren\"",
                analyzing: "Analysiere Umweltdaten f√ºr dein Gesundheitsprofil...",
                hours: "Stunden",
                days: "Tage",
                
                // Conditions
                asthma: "Asthma",
                allergy: "Allergie",
                migraine: "Migr√§ne",
                copd: "Chronische Lungenkrankheit",
                cardiovascular: "Herz-Kreislauf",
                fatigue: "M√ºdigkeit",
                
                // Risk levels
                riskLow: "Niedriges Risiko",
                riskMedium: "Mittleres Risiko",
                riskHigh: "Hohes Risiko",
                riskCritical: "Kritisches Risiko",
                
                // UI
                dailyForecast: "Deine Prognose",
                hourlyForecast: "St√ºndliche Vorhersage",
                healthAssistant: "Gesundheits-Assistent",
                recommendations: "Pers√∂nliche Empfehlungen",
                chatPlaceholder: "Frage zur Gesundheit stellen...",
                send: "Senden",
                
                // Quick actions
                sportToday: "Sport heute?",
                bestTime: "Beste Zeit?",
                tips: "Tipps",
                
                // Status
                good: "Gut",
                moderate: "M√§ssig",
                high: "Hoch",
                low: "Niedrig",
                ok: "OK",
                
                // Triggers
                pm25: "PM2.5 Feinstaub",
                no2: "NO‚ÇÇ Stickstoffdioxid",
                ozone: "O‚ÇÉ Ozon",
                humidity: "Luftfeuchtigkeit",
                pressure: "Luftdruck",
                uvIndex: "UV-Index",
                
                // Thresholds
                whoLimit: "Grenzwert WHO",
                euLimit: "Grenzwert EU",
                warningLevel: "Warnschwelle",
                optimal: "Optimal",
                normal: "Normal",
                sunProtection: "Sonnenschutz ab 3",
                
                // Premium
                premiumTitle: "HealthAir Premium",
                premiumFeatures: "Symptom-Vorhersagen ‚Ä¢ Push-Benachrichtigungen ‚Ä¢ Detaillierte Analysen ‚Ä¢ Familienkonten",
                premiumBtn: "7 Tage kostenlos testen",
                
                // Forecast texts
                goodNews: "Gute Nachrichten!",
                cautionRecommended: "Vorsicht empfohlen",
                elevatedRisk: "Erh√∂htes Risiko",
                conditions: "Die aktuellen Umweltbedingungen sind f√ºr dein Profil g√ºnstig.",
                aqiGreen: "Die Luftqualit√§t ist im gr√ºnen Bereich.",
                potentialTriggers: "Potenzielle Trigger",
                activeTriggers: "Aktive Trigger",
                monitorSymptoms: "Beobachte deine Symptome und halte Medikamente bereit.",
                avoidOutdoor: "Vermeide wenn m√∂glich Aktivit√§ten im Freien.",
                keepMedication: "Halte Notfallmedikamente griffbereit.",
                
                // Tips
                stayIndoors: "Bleibe heute m√∂glichst drinnen und halte Fenster geschlossen.",
                keepInhaler: "Halte dein Notfall-Spray griffbereit.",
                showerAfter: "Dusche nach dem Aufenthalt im Freien, um Pollen abzuwaschen.",
                changeClothes: "Wechsle Kleidung nach draussen, um Pollen nicht ins Schlafzimmer zu bringen.",
                drinkWater: "Trinke ausreichend Wasser - Dehydration kann Migr√§ne triggern.",
                wearSunglasses: "Trage bei Sonnenlicht eine Sonnenbrille.",
                useSunscreen: "Benutze Sonnenschutz mit mindestens LSF 30.",
                enjoyDay: "Die Bedingungen sind heute g√ºnstig. Geniesse den Tag!"
            },
            en: {
                tagline: "Personalized health forecasts ‚Ä¢ AI-powered",
                profileTitle: "My Health Profile",
                locationPlaceholder: "Enter location (e.g. London, UK)",
                timeLabel: "‚è∞ Time range:",
                btnAnalyze: "Analyze",
                initialMsg: "Select your health conditions and click \"Analyze\"",
                analyzing: "Analyzing environmental data for your health profile...",
                hours: "hours",
                days: "days",
                
                asthma: "Asthma",
                allergy: "Allergy",
                migraine: "Migraine",
                copd: "Chronic Lung Disease",
                cardiovascular: "Cardiovascular",
                fatigue: "Fatigue",
                
                riskLow: "Low Risk",
                riskMedium: "Medium Risk",
                riskHigh: "High Risk",
                riskCritical: "Critical Risk",
                
                dailyForecast: "Your Forecast",
                hourlyForecast: "Hourly Forecast",
                healthAssistant: "Health Assistant",
                recommendations: "Personal Recommendations",
                chatPlaceholder: "Ask a health question...",
                send: "Send",
                
                sportToday: "Exercise today?",
                bestTime: "Best time?",
                tips: "Tips",
                
                good: "Good",
                moderate: "Moderate",
                high: "High",
                low: "Low",
                ok: "OK",
                
                pm25: "PM2.5 Fine Dust",
                no2: "NO‚ÇÇ Nitrogen Dioxide",
                ozone: "O‚ÇÉ Ozone",
                humidity: "Humidity",
                pressure: "Air Pressure",
                uvIndex: "UV Index",
                
                whoLimit: "WHO limit",
                euLimit: "EU limit",
                warningLevel: "Warning level",
                optimal: "Optimal",
                normal: "Normal",
                sunProtection: "Sun protection from 3",
                
                premiumTitle: "HealthAir Premium",
                premiumFeatures: "Symptom predictions ‚Ä¢ Push notifications ‚Ä¢ Detailed analyses ‚Ä¢ Family plans",
                premiumBtn: "Try 7 days free",
                
                goodNews: "Good news!",
                cautionRecommended: "Caution recommended",
                elevatedRisk: "Elevated risk",
                conditions: "Current environmental conditions are favorable for your profile.",
                aqiGreen: "Air quality is in the green zone.",
                potentialTriggers: "Potential triggers",
                activeTriggers: "Active triggers",
                monitorSymptoms: "Monitor your symptoms and keep medication ready.",
                avoidOutdoor: "Avoid outdoor activities if possible.",
                keepMedication: "Keep emergency medication within reach.",
                
                stayIndoors: "Stay indoors today and keep windows closed.",
                keepInhaler: "Keep your emergency inhaler within reach.",
                showerAfter: "Shower after being outdoors to wash off pollen.",
                changeClothes: "Change clothes after going outside to avoid bringing pollen into the bedroom.",
                drinkWater: "Drink plenty of water - dehydration can trigger migraines.",
                wearSunglasses: "Wear sunglasses in sunlight.",
                useSunscreen: "Use sunscreen with at least SPF 30.",
                enjoyDay: "Conditions are favorable today. Enjoy your day!"
            },
            fr: {
                tagline: "Pr√©visions de sant√© personnalis√©es ‚Ä¢ Propuls√© par IA",
                profileTitle: "Mon profil de sant√©",
                locationPlaceholder: "Entrer le lieu (ex: Paris, France)",
                timeLabel: "‚è∞ P√©riode:",
                btnAnalyze: "Analyser",
                initialMsg: "S√©lectionnez vos conditions de sant√© et cliquez sur \"Analyser\"",
                analyzing: "Analyse des donn√©es environnementales pour votre profil de sant√©...",
                hours: "heures",
                days: "jours",
                
                asthma: "Asthme",
                allergy: "Allergie",
                migraine: "Migraine",
                copd: "Maladie pulmonaire chronique",
                cardiovascular: "Cardiovasculaire",
                fatigue: "Fatigue",
                
                riskLow: "Risque faible",
                riskMedium: "Risque moyen",
                riskHigh: "Risque √©lev√©",
                riskCritical: "Risque critique",
                
                dailyForecast: "Votre pr√©vision",
                hourlyForecast: "Pr√©vision horaire",
                healthAssistant: "Assistant sant√©",
                recommendations: "Recommandations personnelles",
                chatPlaceholder: "Posez une question de sant√©...",
                send: "Envoyer",
                
                sportToday: "Sport aujourd'hui?",
                bestTime: "Meilleur moment?",
                tips: "Conseils",
                
                good: "Bon",
                moderate: "Mod√©r√©",
                high: "√âlev√©",
                low: "Faible",
                ok: "OK",
                
                pm25: "PM2.5 Particules fines",
                no2: "NO‚ÇÇ Dioxyde d'azote",
                ozone: "O‚ÇÉ Ozone",
                humidity: "Humidit√©",
                pressure: "Pression atmosph√©rique",
                uvIndex: "Indice UV",
                
                whoLimit: "Limite OMS",
                euLimit: "Limite UE",
                warningLevel: "Seuil d'alerte",
                optimal: "Optimal",
                normal: "Normal",
                sunProtection: "Protection solaire d√®s 3",
                
                premiumTitle: "HealthAir Premium",
                premiumFeatures: "Pr√©visions de sympt√¥mes ‚Ä¢ Notifications push ‚Ä¢ Analyses d√©taill√©es ‚Ä¢ Plans famille",
                premiumBtn: "Essai gratuit 7 jours",
                
                goodNews: "Bonne nouvelle!",
                cautionRecommended: "Prudence recommand√©e",
                elevatedRisk: "Risque √©lev√©",
                conditions: "Les conditions environnementales actuelles sont favorables pour votre profil.",
                aqiGreen: "La qualit√© de l'air est dans la zone verte.",
                potentialTriggers: "D√©clencheurs potentiels",
                activeTriggers: "D√©clencheurs actifs",
                monitorSymptoms: "Surveillez vos sympt√¥mes et gardez vos m√©dicaments √† port√©e.",
                avoidOutdoor: "√âvitez les activit√©s en plein air si possible.",
                keepMedication: "Gardez vos m√©dicaments d'urgence √† port√©e de main.",
                
                stayIndoors: "Restez √† l'int√©rieur aujourd'hui et gardez les fen√™tres ferm√©es.",
                keepInhaler: "Gardez votre inhalateur d'urgence √† port√©e de main.",
                showerAfter: "Douchez-vous apr√®s √™tre sorti pour √©liminer le pollen.",
                changeClothes: "Changez de v√™tements apr√®s √™tre sorti pour ne pas apporter de pollen dans la chambre.",
                drinkWater: "Buvez suffisamment d'eau - la d√©shydratation peut d√©clencher des migraines.",
                wearSunglasses: "Portez des lunettes de soleil en plein soleil.",
                useSunscreen: "Utilisez une protection solaire d'au moins SPF 30.",
                enjoyDay: "Les conditions sont favorables aujourd'hui. Profitez de votre journ√©e!"
            },
            it: {
                tagline: "Previsioni di salute personalizzate ‚Ä¢ Powered by AI",
                profileTitle: "Il mio profilo di salute",
                locationPlaceholder: "Inserisci localit√† (es: Milano, Italia)",
                timeLabel: "‚è∞ Periodo:",
                btnAnalyze: "Analizza",
                initialMsg: "Seleziona le tue condizioni di salute e clicca su \"Analizza\"",
                analyzing: "Analisi dei dati ambientali per il tuo profilo di salute...",
                hours: "ore",
                days: "giorni",
                
                asthma: "Asma",
                allergy: "Allergia",
                migraine: "Emicrania",
                copd: "Malattia polmonare cronica",
                cardiovascular: "Cardiovascolare",
                fatigue: "Stanchezza",
                
                riskLow: "Rischio basso",
                riskMedium: "Rischio medio",
                riskHigh: "Rischio alto",
                riskCritical: "Rischio critico",
                
                dailyForecast: "La tua previsione",
                hourlyForecast: "Previsione oraria",
                healthAssistant: "Assistente salute",
                recommendations: "Raccomandazioni personali",
                chatPlaceholder: "Fai una domanda sulla salute...",
                send: "Invia",
                
                sportToday: "Sport oggi?",
                bestTime: "Momento migliore?",
                tips: "Consigli",
                
                good: "Buono",
                moderate: "Moderato",
                high: "Alto",
                low: "Basso",
                ok: "OK",
                
                pm25: "PM2.5 Polveri sottili",
                no2: "NO‚ÇÇ Biossido di azoto",
                ozone: "O‚ÇÉ Ozono",
                humidity: "Umidit√†",
                pressure: "Pressione atmosferica",
                uvIndex: "Indice UV",
                
                whoLimit: "Limite OMS",
                euLimit: "Limite UE",
                warningLevel: "Soglia di allerta",
                optimal: "Ottimale",
                normal: "Normale",
                sunProtection: "Protezione solare da 3",
                
                premiumTitle: "HealthAir Premium",
                premiumFeatures: "Previsioni sintomi ‚Ä¢ Notifiche push ‚Ä¢ Analisi dettagliate ‚Ä¢ Piani famiglia",
                premiumBtn: "Prova gratuita 7 giorni",
                
                goodNews: "Buone notizie!",
                cautionRecommended: "Cautela raccomandata",
                elevatedRisk: "Rischio elevato",
                conditions: "Le condizioni ambientali attuali sono favorevoli per il tuo profilo.",
                aqiGreen: "La qualit√† dell'aria √® nella zona verde.",
                potentialTriggers: "Trigger potenziali",
                activeTriggers: "Trigger attivi",
                monitorSymptoms: "Monitora i tuoi sintomi e tieni i farmaci pronti.",
                avoidOutdoor: "Evita le attivit√† all'aperto se possibile.",
                keepMedication: "Tieni i farmaci d'emergenza a portata di mano.",
                
                stayIndoors: "Rimani in casa oggi e tieni le finestre chiuse.",
                keepInhaler: "Tieni l'inalatore d'emergenza a portata di mano.",
                showerAfter: "Fai la doccia dopo essere stato all'aperto per rimuovere il polline.",
                changeClothes: "Cambia i vestiti dopo essere uscito per non portare polline in camera.",
                drinkWater: "Bevi abbastanza acqua - la disidratazione pu√≤ scatenare l'emicrania.",
                wearSunglasses: "Indossa occhiali da sole alla luce del sole.",
                useSunscreen: "Usa una protezione solare di almeno SPF 30.",
                enjoyDay: "Le condizioni sono favorevoli oggi. Goditi la giornata!"
            }
        };
        
        const t = key => T[currentLang]?.[key] || T['en']?.[key] || key;
        
        // Condition definitions with translations
        const conditionDefs = {
            asthma: { icon: 'ü´Å', triggers: ['pm2_5', 'no2', 'ozone', 'humidity', 'pressure'] },
            allergy: { icon: 'ü§ß', triggers: ['pollen', 'dust', 'humidity'] },
            migraine: { icon: 'ü§ï', triggers: ['pressure', 'humidity', 'temperature_change'] },
            copd: { icon: 'üí®', triggers: ['pm2_5', 'pm10', 'no2', 'co', 'humidity'] },
            cardiovascular: { icon: '‚ù§Ô∏è', triggers: ['pm2_5', 'temperature', 'pressure', 'ozone'] },
            fatigue: { icon: 'üò¥', triggers: ['pressure', 'humidity', 'uv'] }
        };
        
        // === INITIALIZATION ===
        function init() {
            // Load saved language
            const savedLang = localStorage.getItem('healthair_lang');
            if (savedLang) {
                currentLang = savedLang;
                document.getElementById('language').value = savedLang;
            }
            
            // Load saved conditions
            const savedConds = localStorage.getItem('healthair_conditions');
            if (savedConds) {
                selectedConditions = JSON.parse(savedConds);
            }
            
            renderConditionButtons();
            applyTranslations();
        }
        
        function changeLanguage() {
            currentLang = document.getElementById('language').value;
            localStorage.setItem('healthair_lang', currentLang);
            renderConditionButtons();
            applyTranslations();
            if (currentData) {
                renderHealthAnalysis(currentData);
            }
        }
        
        function applyTranslations() {
            document.getElementById('tagline').textContent = t('tagline');
            document.getElementById('profileTitle').textContent = t('profileTitle');
            document.getElementById('location').placeholder = t('locationPlaceholder');
            document.getElementById('timeLabel').textContent = t('timeLabel');
            document.getElementById('btnAnalyze').textContent = t('btnAnalyze');
            document.getElementById('initialMsg').textContent = t('initialMsg');
            
            // Time range options
            const timeSelect = document.getElementById('timeRange');
            timeSelect.options[0].text = `6 ${t('hours')}`;
            timeSelect.options[1].text = `12 ${t('hours')}`;
            timeSelect.options[2].text = `24 ${t('hours')}`;
            timeSelect.options[3].text = `48 ${t('hours')}`;
            timeSelect.options[4].text = `3 ${t('days')}`;
        }
        
        function renderConditionButtons() {
            const container = document.getElementById('conditions');
            container.innerHTML = Object.entries(conditionDefs).map(([key, def]) => `
                <button class="condition-btn ${selectedConditions.includes(key) ? 'selected' : ''}" 
                        data-condition="${key}" onclick="toggleCondition(this)">
                    <span class="icon">${def.icon}</span>${t(key)}
                </button>
            `).join('');
        }
        
        function toggleCondition(btn) {
            const cond = btn.dataset.condition;
            if (selectedConditions.includes(cond)) {
                selectedConditions = selectedConditions.filter(c => c !== cond);
                btn.classList.remove('selected');
            } else {
                selectedConditions.push(cond);
                btn.classList.add('selected');
            }
            localStorage.setItem('healthair_conditions', JSON.stringify(selectedConditions));
        }
        
        // === GEOLOCATION ===
        async function useGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async pos => {
                        lat = pos.coords.latitude;
                        lon = pos.coords.longitude;
                        // Reverse geocode
                        await reverseGeocode(lat, lon);
                        analyze();
                    },
                    err => alert('GPS Error: ' + err.message)
                );
            }
        }
        
        async function reverseGeocode(latitude, longitude) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=${currentLang}`);
                const data = await res.json();
                const city = data.address?.city || data.address?.town || data.address?.village || data.address?.municipality || '';
                const country = data.address?.country || '';
                locationName = city && country ? `${city}, ${country}` : `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                document.getElementById('location').value = locationName;
            } catch (e) {
                locationName = `${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                document.getElementById('location').value = locationName;
            }
        }
        
        async function geocodeLocation(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=${currentLang}`);
                const data = await res.json();
                if (data.length > 0) {
                    lat = parseFloat(data[0].lat);
                    lon = parseFloat(data[0].lon);
                    locationName = data[0].display_name.split(',').slice(0, 2).join(',');
                    return true;
                }
            } catch (e) {
                console.error('Geocoding error:', e);
            }
            return false;
        }
        
        // === ANALYSIS ===
        async function analyze() {
            if (selectedConditions.length === 0) {
                alert(currentLang === 'de' ? 'Bitte w√§hle mindestens eine Gesundheitsbedingung aus.' : 
                      currentLang === 'fr' ? 'Veuillez s√©lectionner au moins une condition de sant√©.' :
                      currentLang === 'it' ? 'Seleziona almeno una condizione di salute.' :
                      'Please select at least one health condition.');
                return;
            }
            
            // Geocode if location text changed
            const locInput = document.getElementById('location').value.trim();
            if (locInput && locInput !== locationName) {
                const success = await geocodeLocation(locInput);
                if (!success) {
                    alert(currentLang === 'de' ? 'Ort nicht gefunden. Bitte √ºberpr√ºfen.' :
                          currentLang === 'fr' ? 'Lieu non trouv√©. Veuillez v√©rifier.' :
                          currentLang === 'it' ? 'Luogo non trovato. Si prega di verificare.' :
                          'Location not found. Please check.');
                    return;
                }
            }
            
            document.getElementById('main-content').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>${t('analyzing')}</p>
                </div>`;
            
            try {
                const res = await fetch(`${API}/data/?lat=${lat}&lon=${lon}`);
                const data = await res.json();
                currentData = data;
                renderHealthAnalysis(data);
            } catch (e) {
                document.getElementById('main-content').innerHTML = `
                    <div class="loading">
                        <p>‚ùå Error: ${e.message}</p>
                        <button class="btn btn-primary" onclick="analyze()">${t('btnAnalyze')}</button>
                    </div>`;
            }
        }
        
        function calculateHealthRisk(data) {
            let riskScore = 0;
            let riskFactors = [];
            
            const air = data.air_quality || {};
            const weather = data.weather || {};
            const pollen = data.pollen || {};
            
            // PM2.5
            if (air.pm2_5) {
                if (air.pm2_5 > 35) { riskScore += 3; riskFactors.push(`PM2.5 ${t('high')} (${air.pm2_5.toFixed(0)} Œºg/m¬≥)`); }
                else if (air.pm2_5 > 15) { riskScore += 1; }
            }
            
            // NO2
            if (air.no2) {
                if (air.no2 > 100) { riskScore += 3; riskFactors.push(`NO‚ÇÇ ${t('high')}`); }
                else if (air.no2 > 40) { riskScore += 1; riskFactors.push(`NO‚ÇÇ ${t('moderate')}`); }
            }
            
            // Ozone
            if (air.ozone) {
                if (air.ozone > 180) { riskScore += 3; riskFactors.push(`${t('ozone')} ${t('high')}`); }
                else if (air.ozone > 100) { riskScore += 1; }
            }
            
            // Humidity
            if (weather.humidity) {
                if (weather.humidity > 85) { riskScore += 2; riskFactors.push(`${t('humidity')} ${t('high')} (${weather.humidity}%)`); }
                else if (weather.humidity > 70) { riskScore += 1; }
            }
            
            // Pollen
            if (pollen.high_pollen?.length > 0) {
                riskScore += 2 * pollen.high_pollen.length;
                riskFactors.push(`Pollen: ${pollen.high_pollen.join(', ')}`);
            }
            
            // Pressure
            if (weather.pressure && (weather.pressure < 1000 || weather.pressure > 1030)) {
                riskScore += 2;
                riskFactors.push(`${t('pressure')} (${weather.pressure} hPa)`);
            }
            
            // UV
            if (air.uv_index >= 8) {
                riskScore += 2;
                riskFactors.push(`${t('uvIndex')} ${t('high')} (${air.uv_index})`);
            }
            
            let level = 'low';
            if (riskScore >= 8) level = 'critical';
            else if (riskScore >= 5) level = 'high';
            else if (riskScore >= 2) level = 'medium';
            
            return { score: riskScore, level, factors: [...new Set(riskFactors)] };
        }
        
        function generateForecast(data, risk) {
            const condNames = selectedConditions.map(c => t(c)).join(', ');
            const air = data.air_quality || {};
            
            if (risk.level === 'low') {
                return `<span class="forecast-good">${t('goodNews')}</span> ${t('conditions')} ${t('aqiGreen')}`;
            } else if (risk.level === 'medium') {
                return `<span class="forecast-highlight">${t('cautionRecommended')}</span> (${condNames}). ` +
                       (risk.factors.length > 0 ? `${t('potentialTriggers')}: ${risk.factors.slice(0,2).join(', ')}. ` : '') +
                       t('monitorSymptoms');
            } else {
                return `<span class="forecast-highlight">${t('elevatedRisk')}</span> (${condNames})! ` +
                       `${t('activeTriggers')}: ${risk.factors.join(', ')}. ` +
                       t('avoidOutdoor') + ' ' + t('keepMedication');
            }
        }
        
        function renderHealthAnalysis(data) {
            const risk = calculateHealthRisk(data);
            const forecast = generateForecast(data, risk);
            const air = data.air_quality || {};
            const weather = data.weather || {};
            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            const riskClass = { low: 'risk-low', medium: 'risk-medium', high: 'risk-high', critical: 'risk-critical' }[risk.level];
            const riskLabel = { low: t('riskLow'), medium: t('riskMedium'), high: t('riskHigh'), critical: t('riskCritical') }[risk.level];
            
            // Generate hourly forecast
            const hours = [];
            const now = new Date();
            for (let i = 0; i < timeRange; i++) {
                const h = new Date(now.getTime() + i * 3600000);
                const hourRisk = Math.random() > 0.7 ? (Math.random() > 0.5 ? 'danger' : 'warning') : '';
                hours.push({
                    time: h.getHours().toString().padStart(2, '0') + ':00',
                    date: h.getDate() !== now.getDate() ? h.toLocaleDateString(currentLang, { day: 'numeric', month: 'short' }) : '',
                    risk: hourRisk,
                    icon: hourRisk === 'danger' ? '‚ö†Ô∏è' : hourRisk === 'warning' ? '‚ö°' : '‚úì',
                    label: hourRisk === 'danger' ? t('high') : hourRisk === 'warning' ? t('moderate') : t('ok')
                });
            }
            
            const getStatus = (val, th) => {
                if (val == null) return { class: '', text: '' };
                if (val <= th[0]) return { class: 'status-good', text: t('good') };
                if (val <= th[1]) return { class: 'status-moderate', text: t('moderate') };
                return { class: 'status-bad', text: t('high') };
            };
            
            const pm25Status = getStatus(air.pm2_5, [15, 35]);
            const no2Status = getStatus(air.no2, [40, 100]);
            const o3Status = getStatus(air.ozone, [100, 180]);
            const humStatus = getStatus(weather.humidity, [60, 80]);
            
            document.getElementById('main-content').innerHTML = `
                <!-- Risk Summary -->
                <div class="risk-card">
                    <div class="risk-header">
                        <div>
                            <div class="risk-title">üìä ${t('dailyForecast')}</div>
                            <div class="risk-subtitle">üìç ${locationName || `${lat.toFixed(2)}, ${lon.toFixed(2)}`}</div>
                        </div>
                        <span class="risk-badge ${riskClass}">${riskLabel}</span>
                    </div>
                    <div class="symptom-forecast">
                        <div class="forecast-text">${forecast}</div>
                    </div>
                    ${risk.factors.length > 0 ? `
                        <div style="display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;">
                            ${risk.factors.map(f => `<span style="background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:8px;font-size:0.8rem;">‚ö†Ô∏è ${f}</span>`).join('')}
                        </div>
                    ` : ''}
                </div>
                
                <!-- Hourly Timeline -->
                <div class="timeline-card">
                    <div class="timeline-title">‚è∞ ${t('hourlyForecast')} (${timeRange}h)</div>
                    <div class="timeline-scroll">
                        ${hours.map(h => `
                            <div class="hour-block ${h.risk}">
                                <div class="hour-time">${h.time}</div>
                                ${h.date ? `<div class="hour-date">${h.date}</div>` : ''}
                                <div class="hour-risk">${h.icon}</div>
                                <div class="hour-label">${h.label}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <!-- Trigger Cards -->
                <div class="triggers-grid">
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">üí®</span>
                            <span class="trigger-title">${t('pm25')}</span>
                        </div>
                        <div class="trigger-value">${air.pm2_5?.toFixed(1) || 'N/A'} <span style="font-size:0.8rem;font-weight:400;">Œºg/m¬≥</span>
                            <span class="trigger-status ${pm25Status.class}">${pm25Status.text}</span>
                        </div>
                        <div class="trigger-detail">${t('whoLimit')}: 15 Œºg/m¬≥</div>
                    </div>
                    
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">üöó</span>
                            <span class="trigger-title">${t('no2')}</span>
                        </div>
                        <div class="trigger-value">${air.no2?.toFixed(1) || 'N/A'} <span style="font-size:0.8rem;font-weight:400;">Œºg/m¬≥</span>
                            <span class="trigger-status ${no2Status.class}">${no2Status.text}</span>
                        </div>
                        <div class="trigger-detail">${t('euLimit')}: 40 Œºg/m¬≥</div>
                    </div>
                    
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">‚òÄÔ∏è</span>
                            <span class="trigger-title">${t('ozone')}</span>
                        </div>
                        <div class="trigger-value">${air.ozone?.toFixed(0) || 'N/A'} <span style="font-size:0.8rem;font-weight:400;">Œºg/m¬≥</span>
                            <span class="trigger-status ${o3Status.class}">${o3Status.text}</span>
                        </div>
                        <div class="trigger-detail">${t('warningLevel')}: 180 Œºg/m¬≥</div>
                    </div>
                    
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">üíß</span>
                            <span class="trigger-title">${t('humidity')}</span>
                        </div>
                        <div class="trigger-value">${weather.humidity || 'N/A'}<span style="font-size:0.8rem;font-weight:400;">%</span>
                            <span class="trigger-status ${humStatus.class}">${humStatus.text}</span>
                        </div>
                        <div class="trigger-detail">${t('optimal')}: 40-60%</div>
                    </div>
                    
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">üå°Ô∏è</span>
                            <span class="trigger-title">${t('pressure')}</span>
                        </div>
                        <div class="trigger-value">${weather.pressure || 'N/A'} <span style="font-size:0.8rem;font-weight:400;">hPa</span></div>
                        <div class="trigger-detail">${t('normal')}: 1013 hPa</div>
                    </div>
                    
                    <div class="trigger-card">
                        <div class="trigger-header">
                            <span class="trigger-icon">‚òÄÔ∏è</span>
                            <span class="trigger-title">${t('uvIndex')}</span>
                        </div>
                        <div class="trigger-value">${air.uv_index?.toFixed(1) || 'N/A'}
                            <span class="trigger-status ${air.uv_index >= 6 ? 'status-bad' : air.uv_index >= 3 ? 'status-moderate' : 'status-good'}">${air.uv_index >= 6 ? t('high') : air.uv_index >= 3 ? t('moderate') : t('low')}</span>
                        </div>
                        <div class="trigger-detail">${t('sunProtection')}</div>
                    </div>
                </div>
                
                <!-- AI Chat -->
                <div class="chat-card">
                    <div class="chat-title">ü§ñ ${t('healthAssistant')}</div>
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="askQuestion('${t('sportToday')}')">üèÉ ${t('sportToday')}</button>
                        <button class="quick-btn" onclick="askQuestion('${t('bestTime')}')">‚è∞ ${t('bestTime')}</button>
                        <button class="quick-btn" onclick="askQuestion('${t('tips')}')">üíä ${t('tips')}</button>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-row">
                        <input type="text" class="chat-input" id="chat-input" placeholder="${t('chatPlaceholder')}" onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="chat-send" onclick="sendChat()">${t('send')}</button>
                    </div>
                </div>
                
                <!-- Tips -->
                <div class="tips-card">
                    <div class="tips-title">üí° ${t('recommendations')}</div>
                    ${generateTips(data, risk)}
                </div>
                
                <!-- Premium Banner -->
                <div class="premium-banner">
                    <div class="premium-title">üöÄ ${t('premiumTitle')}</div>
                    <div class="premium-features">${t('premiumFeatures')}</div>
                    <button class="premium-btn">${t('premiumBtn')}</button>
                </div>
            `;
            
            fetchInitialChat();
        }
        
        function generateTips(data, risk) {
            const tips = [];
            const air = data.air_quality || {};
            
            if (selectedConditions.includes('asthma') || selectedConditions.includes('copd')) {
                if (air.pm2_5 > 25) tips.push({ icon: 'üè†', text: t('stayIndoors') });
                tips.push({ icon: 'üíä', text: t('keepInhaler') });
            }
            
            if (selectedConditions.includes('allergy')) {
                tips.push({ icon: 'üöø', text: t('showerAfter') });
                tips.push({ icon: 'üëï', text: t('changeClothes') });
            }
            
            if (selectedConditions.includes('migraine')) {
                tips.push({ icon: 'üíß', text: t('drinkWater') });
                tips.push({ icon: 'üòé', text: t('wearSunglasses') });
            }
            
            if (air.uv_index >= 6) {
                tips.push({ icon: 'üß¥', text: t('useSunscreen') });
            }
            
            if (tips.length === 0) {
                tips.push({ icon: '‚ú®', text: t('enjoyDay') });
            }
            
            return tips.map(tip => `<div class="tip-item"><span class="tip-icon">${tip.icon}</span><span>${tip.text}</span></div>`).join('');
        }
        
        // === CHAT ===
        
        // Map selected conditions to a profile string for the API
        function getHealthProfile() {
            // Create a descriptive profile based on selected conditions
            const profileMap = {
                asthma: 'Asthma',
                allergy: 'Allergy',
                migraine: 'Migraine',
                copd: 'COPD/Respiratory',
                cardiovascular: 'Cardiovascular',
                fatigue: 'Fatigue/Sleep'
            };
            const profiles = selectedConditions.map(c => profileMap[c] || c);
            return profiles.join(', ') || 'General Health';
        }
        
        async function fetchInitialChat() {
            const condNames = selectedConditions.map(c => t(c)).join(', ');
            const healthProfile = getHealthProfile();
            
            // IMPORTANT: Include explicit instruction about which conditions the user has
            const langPrompt = {
                de: `WICHTIG: Der Nutzer hat NUR folgende Gesundheitsbeschwerden ausgew√§hlt: ${condNames}. Beziehe dich AUSSCHLIESSLICH auf diese Beschwerden, nicht auf andere! Gib eine kurze, pers√∂nliche Begr√ºssung und fasse zusammen, worauf der Nutzer heute mit diesen spezifischen Beschwerden achten sollte.`,
                en: `IMPORTANT: The user has ONLY selected these health conditions: ${condNames}. Refer EXCLUSIVELY to these conditions, not others! Give a brief, personal greeting and summarize what the user should watch out for today with these specific conditions.`,
                fr: `IMPORTANT: L'utilisateur a UNIQUEMENT s√©lectionn√© ces conditions de sant√©: ${condNames}. R√©f√©rez-vous EXCLUSIVEMENT √† ces conditions, pas √† d'autres! Donnez une br√®ve salutation personnelle et r√©sumez ce √† quoi l'utilisateur doit faire attention aujourd'hui avec ces conditions sp√©cifiques.`,
                it: `IMPORTANTE: L'utente ha selezionato SOLO queste condizioni di salute: ${condNames}. Riferisciti ESCLUSIVAMENTE a queste condizioni, non ad altre! Dai un breve saluto personale e riassumi a cosa l'utente dovrebbe fare attenzione oggi con queste condizioni specifiche.`
            };
            
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(healthProfile)}&language=${currentLang}&question=${encodeURIComponent(langPrompt[currentLang])}`, { method: 'POST' });
                const data = await res.json();
                chatHistory = [{ role: 'ai', text: data.answer }];
                renderChat();
            } catch (e) {
                console.error(e);
            }
        }
        
        function renderChat() {
            const el = document.getElementById('chat-messages');
            if (!el) return;
            el.innerHTML = chatHistory.map(m => 
                m.role === 'user' 
                    ? `<div class="chat-msg chat-user">${m.text}</div>`
                    : `<div class="chat-msg chat-ai">ü§ñ ${m.text}</div>`
            ).join('');
            el.scrollTop = el.scrollHeight;
        }
        
        function askQuestion(q) {
            document.getElementById('chat-input').value = q;
            sendChat();
        }
        
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const q = input.value.trim();
            if (!q) return;
            
            chatHistory.push({ role: 'user', text: q });
            renderChat();
            input.value = '';
            
            const condNames = selectedConditions.map(c => t(c)).join(', ');
            const healthProfile = getHealthProfile();
            
            // Strong context about selected conditions
            const contextIntro = {
                de: `WICHTIG: Ich habe NUR diese Gesundheitsbeschwerden: ${condNames}. Beantworte meine Frage nur in Bezug auf diese Beschwerden.`,
                en: `IMPORTANT: I ONLY have these health conditions: ${condNames}. Answer my question only regarding these conditions.`,
                fr: `IMPORTANT: J'ai UNIQUEMENT ces conditions de sant√©: ${condNames}. R√©pondez √† ma question uniquement concernant ces conditions.`,
                it: `IMPORTANTE: Ho SOLO queste condizioni di salute: ${condNames}. Rispondi alla mia domanda solo riguardo a queste condizioni.`
            };
            const context = contextIntro[currentLang] || contextIntro.en;
            
            const el = document.getElementById('chat-messages');
            el.innerHTML += `<div class="chat-msg chat-ai" id="typing">üí≠ ...</div>`;
            el.scrollTop = el.scrollHeight;
            
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(healthProfile)}&language=${currentLang}&question=${encodeURIComponent(context + '\n\nMeine Frage: ' + q)}`, { method: 'POST' });
                const data = await res.json();
                document.getElementById('typing')?.remove();
                chatHistory.push({ role: 'ai', text: data.answer });
                renderChat();
            } catch (e) {
                document.getElementById('typing')?.remove();
                chatHistory.push({ role: 'ai', text: '‚ùå Error: ' + e.message });
                renderChat();
            }
        }
        
        // Initialize on load
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
