<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HealthAir - Dein Umwelt-Gesundheitscoach</title>
    <meta name="description" content="Personalisierte Gesundheitsprognosen basierend auf Luftqualit√§t, Wetter und Umweltfaktoren.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #f8fafc;
            --card: #ffffff;
            --border: #e2e8f0;
            --text: #1e293b;
            --text-dim: #64748b;
            --primary: #0ea5e9;
            --primary-dark: #0284c7;
            --success: #10b981;
            --success-bg: #ecfdf5;
            --warning: #f59e0b;
            --warning-bg: #fffbeb;
            --danger: #ef4444;
            --danger-bg: #fef2f2;
            --orange: #f97316;
            --orange-bg: #fff7ed;
            --purple: #8b5cf6;
            --gradient: linear-gradient(135deg, #0ea5e9 0%, #8b5cf6 100%);
        }
        
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        
        .container { max-width: 800px; margin: 0 auto; padding: 16px; }
        
        /* Language Bar */
        .lang-bar {
            background: #1e293b;
            padding: 8px 16px;
            display: flex;
            justify-content: flex-end;
            align-items: center;
        }
        .lang-bar select {
            background: transparent;
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        .lang-bar select option { color: #1e293b; }
        
        /* Header */
        header {
            background: var(--gradient);
            color: white;
            padding: 24px 16px;
            text-align: center;
        }
        .logo { font-size: 2rem; font-weight: 700; margin-bottom: 4px; }
        .tagline { font-size: 0.9rem; opacity: 0.9; }
        
        /* Profile Card */
        .profile-card {
            background: var(--card);
            border-radius: 16px;
            padding: 20px;
            margin: -30px 16px 16px 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            position: relative;
            z-index: 10;
        }
        .profile-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .condition-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 16px;
        }
        .condition-btn {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg);
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            font-size: 0.9rem;
        }
        .condition-btn:hover { border-color: var(--primary); }
        .condition-btn.active {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
            color: var(--primary-dark);
        }
        .condition-icon { font-size: 1.3rem; display: block; margin-bottom: 4px; }
        
        .location-row {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }
        .location-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 1rem;
        }
        .location-input:focus { outline: none; border-color: var(--primary); }
        .gps-btn {
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--card);
            cursor: pointer;
            font-size: 1.1rem;
        }
        .gps-btn:hover { border-color: var(--primary); }
        
        .time-row {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
        }
        .time-label { font-size: 0.9rem; color: var(--text-dim); }
        .time-select {
            padding: 8px 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 0.9rem;
            background: var(--card);
        }
        
        .analyze-btn {
            width: 100%;
            padding: 14px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .analyze-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3); }
        
        /* Health Score Card */
        .health-score-card {
            background: var(--card);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            text-align: center;
        }
        .score-header {
            font-size: 0.85rem;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }
        .score-circle {
            width: 140px;
            height: 140px;
            border-radius: 50%;
            margin: 0 auto 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        .score-circle::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 50%;
            padding: 6px;
            background: conic-gradient(var(--score-color) calc(var(--score-pct) * 3.6deg), #e2e8f0 0);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
        .score-value { font-size: 3rem; font-weight: 700; line-height: 1; }
        .score-max { font-size: 1rem; color: var(--text-dim); }
        .score-label { font-size: 1.3rem; font-weight: 600; margin-bottom: 8px; }
        .score-location { font-size: 0.9rem; color: var(--text-dim); }
        
        .health-bar {
            height: 12px;
            border-radius: 6px;
            background: linear-gradient(to right, #10b981 0%, #10b981 25%, #f59e0b 25%, #f59e0b 50%, #f97316 50%, #f97316 75%, #ef4444 75%, #ef4444 100%);
            margin: 16px 0;
            position: relative;
        }
        .health-bar-marker {
            position: absolute;
            top: -4px;
            width: 20px;
            height: 20px;
            background: white;
            border: 3px solid var(--text);
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.2);
        }
        .health-bar-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        /* Prognosis Card */
        .prognosis-card {
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            border-left: 5px solid;
        }
        .prognosis-card.risk-low { background: var(--success-bg); border-color: var(--success); }
        .prognosis-card.risk-medium { background: var(--warning-bg); border-color: var(--warning); }
        .prognosis-card.risk-high { background: var(--orange-bg); border-color: var(--orange); }
        .prognosis-card.risk-critical { background: var(--danger-bg); border-color: var(--danger); }
        .prognosis-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .prognosis-icon { font-size: 2rem; }
        .prognosis-title { font-size: 1.2rem; font-weight: 700; }
        .prognosis-main {
            font-size: 1.05rem;
            font-weight: 500;
            margin-bottom: 12px;
            line-height: 1.5;
        }
        .prognosis-recommendation {
            background: rgba(255,255,255,0.7);
            padding: 12px 16px;
            border-radius: 10px;
            font-size: 0.95rem;
        }
        .prognosis-recommendation strong { color: var(--primary-dark); }
        .prognosis-details { margin-top: 12px; padding-top: 12px; border-top: 1px solid rgba(0,0,0,0.1); }
        .prognosis-toggle {
            font-size: 0.85rem;
            color: var(--primary);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .prognosis-expanded { margin-top: 12px; font-size: 0.9rem; display: none; }
        .prognosis-expanded.show { display: block; }
        .trigger-list { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px; }
        .trigger-chip {
            background: rgba(0,0,0,0.08);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trigger-chip.high { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        
        /* Timeline - Hourly */
        .timeline-card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        .timeline-title { font-weight: 600; font-size: 0.95rem; }
        .timeline-selected-info {
            font-size: 0.85rem;
            color: var(--primary);
            font-weight: 500;
        }
        .timeline-nav { display: flex; gap: 8px; }
        .timeline-nav-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: var(--card);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
        }
        .timeline-nav-btn:hover { background: var(--bg); }
        .timeline-scroll {
            display: flex;
            gap: 8px;
            overflow-x: auto;
            scroll-snap-type: x mandatory;
            scrollbar-width: none;
            padding: 8px 0;
        }
        .timeline-scroll::-webkit-scrollbar { display: none; }
        .timeline-hour {
            flex: 0 0 70px;
            text-align: center;
            padding: 12px 8px;
            border-radius: 12px;
            background: var(--bg);
            scroll-snap-align: start;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            border: 2px solid transparent;
        }
        .timeline-hour:hover { background: #e2e8f0; transform: translateY(-2px); }
        .timeline-hour.selected {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.1);
        }
        .timeline-hour.now { background: var(--primary); color: white; }
        .timeline-hour.now.selected { border-color: var(--primary-dark); }
        .timeline-hour .time { font-weight: 600; font-size: 0.9rem; }
        .timeline-hour .date { font-size: 0.7rem; color: var(--text-dim); margin-top: 2px; }
        .timeline-hour.now .date { color: rgba(255,255,255,0.8); }
        .timeline-hour .risk-indicator { margin-top: 8px; font-size: 1.2rem; }
        .timeline-hour .trend { font-size: 0.75rem; margin-top: 4px; }
        .trend-up { color: var(--danger); }
        .trend-down { color: var(--success); }
        .trend-stable { color: var(--text-dim); }
        
        /* Day Cards (for 3+ days) */
        .day-cards { display: flex; flex-direction: column; gap: 10px; }
        .day-card {
            display: flex;
            align-items: center;
            padding: 16px;
            background: var(--bg);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }
        .day-card:hover { background: #e2e8f0; }
        .day-card.selected { border-color: var(--primary); background: rgba(14, 165, 233, 0.05); }
        .day-card.expanded { border-color: var(--primary); }
        .day-card-main { flex: 1; display: flex; align-items: center; gap: 16px; }
        .day-card-name { font-weight: 600; min-width: 100px; }
        .day-card-risk {
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .day-card-risk.low { background: var(--success-bg); color: var(--success); }
        .day-card-risk.medium { background: var(--warning-bg); color: var(--warning); }
        .day-card-risk.high { background: var(--orange-bg); color: var(--orange); }
        .day-card-risk.critical { background: var(--danger-bg); color: var(--danger); }
        .day-card-summary { flex: 1; font-size: 0.9rem; color: var(--text-dim); }
        .day-card-expand { font-size: 1.2rem; color: var(--text-dim); transition: transform 0.2s; }
        .day-card.expanded .day-card-expand { transform: rotate(180deg); }
        .day-card-hours {
            display: none;
            margin-top: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }
        .day-card.expanded .day-card-hours { display: block; }
        
        /* Trigger Cards */
        .triggers-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }
        .trigger-card {
            background: var(--card);
            border-radius: 14px;
            padding: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: relative;
        }
        .trigger-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        .trigger-card-title {
            font-size: 0.8rem;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .trigger-card-icon { font-size: 1rem; }
        .info-btn {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 1px solid var(--border);
            background: var(--bg);
            font-size: 0.7rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
        }
        .info-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .trigger-card-value { font-size: 1.8rem; font-weight: 700; line-height: 1.2; }
        .trigger-card-unit { font-size: 0.9rem; font-weight: 400; color: var(--text-dim); }
        .trigger-card-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-top: 4px;
        }
        .badge-good { background: var(--success-bg); color: var(--success); }
        .badge-moderate { background: var(--warning-bg); color: var(--warning); }
        .badge-high { background: var(--orange-bg); color: var(--orange); }
        .badge-bad { background: var(--danger-bg); color: var(--danger); }
        .trigger-card-limit { font-size: 0.75rem; color: var(--text-dim); margin-top: 6px; }
        .trigger-card-context {
            font-size: 0.8rem;
            color: var(--text-dim);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-style: italic;
        }
        
        /* Info Popup */
        .info-popup {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            color: white;
            padding: 12px;
            border-radius: 14px;
            font-size: 0.85rem;
            z-index: 50;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s;
        }
        .info-popup.show { opacity: 1; visibility: visible; }
        .info-popup-close {
            position: absolute;
            top: 8px;
            right: 8px;
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 1rem;
        }
        
        /* Micro Recommendations */
        .micro-recs {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .micro-recs-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .micro-rec-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: var(--bg);
            border-radius: 12px;
            margin-bottom: 8px;
            font-size: 0.9rem;
        }
        .micro-rec-item:last-child { margin-bottom: 0; }
        .micro-rec-icon { font-size: 1.3rem; flex-shrink: 0; }
        .micro-rec-text { flex: 1; }
        .micro-rec-highlight { font-weight: 600; color: var(--primary-dark); }
        
        /* Chat / Coach */
        .chat-card {
            background: var(--card);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        .chat-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }
        .chat-avatar {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--gradient);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
        }
        .chat-header-text h3 { font-size: 1rem; font-weight: 600; }
        .chat-header-text p { font-size: 0.8rem; color: var(--text-dim); }
        .chat-quick-btns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 12px;
        }
        .chat-quick-btn {
            padding: 8px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            background: var(--card);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }
        .chat-quick-btn:hover {
            border-color: var(--primary);
            background: rgba(14, 165, 233, 0.05);
        }
        .chat-messages {
            max-height: 350px;
            overflow-y: auto;
            margin-bottom: 12px;
        }
        .chat-msg {
            padding: 12px 16px;
            border-radius: 16px;
            margin-bottom: 10px;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .chat-user {
            background: var(--primary);
            color: white;
            margin-left: 20%;
            border-bottom-right-radius: 4px;
        }
        .chat-ai {
            background: var(--bg);
            margin-right: 10%;
            border-bottom-left-radius: 4px;
        }
        /* Structured Coach Response */
        .coach-response {
            background: var(--bg);
            border-radius: 16px;
            padding: 0;
            margin-right: 10%;
            margin-bottom: 10px;
            overflow: hidden;
        }
        .coach-section {
            padding: 12px 16px;
            border-bottom: 1px solid var(--border);
        }
        .coach-section:last-child { border-bottom: none; }
        .coach-section-title {
            font-weight: 600;
            font-size: 0.8rem;
            color: var(--primary-dark);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .coach-section-content {
            font-size: 0.9rem;
            line-height: 1.5;
        }
        .coach-section-content ul {
            margin: 0;
            padding-left: 20px;
        }
        .coach-section-content li {
            margin-bottom: 4px;
        }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid var(--border);
            border-radius: 24px;
            font-size: 0.9rem;
        }
        .chat-input:focus { outline: none; border-color: var(--primary); }
        .chat-send {
            padding: 12px 20px;
            background: var(--gradient);
            color: white;
            border: none;
            border-radius: 24px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* Feedback Card */
        .feedback-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid var(--primary);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            text-align: center;
        }
        .feedback-title { font-weight: 600; margin-bottom: 12px; font-size: 1rem; }
        .feedback-subtitle { font-size: 0.85rem; color: var(--text-dim); margin-bottom: 12px; }
        .feedback-btns { display: flex; justify-content: center; gap: 12px; }
        .feedback-btn {
            padding: 12px 24px;
            border-radius: 12px;
            border: 2px solid var(--border);
            background: white;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .feedback-btn:hover { transform: scale(1.05); }
        .feedback-btn.yes:hover { border-color: var(--danger); background: var(--danger-bg); }
        .feedback-btn.no:hover { border-color: var(--success); background: var(--success-bg); }
        .feedback-thanks {
            padding: 16px;
            background: var(--success-bg);
            border-radius: 12px;
            color: var(--success);
            font-weight: 500;
        }
        
        /* Premium Banner */
        .premium-banner {
            background: linear-gradient(135deg, #8b5cf6 0%, #6366f1 100%);
            border-radius: 16px;
            padding: 24px;
            color: white;
            margin-bottom: 16px;
        }
        .premium-title {
            font-size: 1.2rem;
            font-weight: 700;
            margin-bottom: 16px;
            text-align: center;
        }
        .premium-features {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }
        .premium-feature {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.95rem;
        }
        .premium-feature-icon {
            width: 24px;
            height: 24px;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
        }
        .premium-btn {
            display: block;
            text-align: center;
            padding: 14px 24px;
            background: white;
            color: var(--purple);
            border-radius: 12px;
            font-weight: 700;
            text-decoration: none;
            font-size: 1rem;
        }
        .premium-btn:hover { transform: scale(1.02); }
        .premium-note {
            text-align: center;
            font-size: 0.8rem;
            opacity: 0.8;
            margin-top: 10px;
        }
        
        .loading { text-align: center; padding: 40px; color: var(--text-dim); }
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 12px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        @media (max-width: 500px) {
            .triggers-grid { grid-template-columns: 1fr; }
            .condition-grid { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="lang-bar">
        <select id="language" onchange="changeLanguage()">
            <option value="de">üá©üá™ Deutsch</option>
            <option value="en">üá¨üáß English</option>
            <option value="fr">üá´üá∑ Fran√ßais</option>
            <option value="it">üáÆüáπ Italiano</option>
        </select>
    </div>

    <header>
        <div class="logo">ü´Å HealthAir</div>
        <p class="tagline" id="tagline">Dein pers√∂nlicher Umwelt-Gesundheitscoach</p>
    </header>
    
    <div class="profile-card">
        <div class="profile-title">üë§ <span id="profileTitle">Mein Gesundheitsprofil</span></div>
        
        <div class="condition-grid" id="conditions">
            <button class="condition-btn" data-condition="asthma" onclick="toggleCondition(this)">
                <span class="condition-icon">ü´Å</span>
                <span class="condition-name">Asthma</span>
            </button>
            <button class="condition-btn" data-condition="allergy" onclick="toggleCondition(this)">
                <span class="condition-icon">ü§ß</span>
                <span class="condition-name">Allergie</span>
            </button>
            <button class="condition-btn" data-condition="migraine" onclick="toggleCondition(this)">
                <span class="condition-icon">ü§ï</span>
                <span class="condition-name">Migr√§ne</span>
            </button>
            <button class="condition-btn" data-condition="copd" onclick="toggleCondition(this)">
                <span class="condition-icon">üí®</span>
                <span class="condition-name">Chron. Lungenkrankheit</span>
            </button>
            <button class="condition-btn" data-condition="cardiovascular" onclick="toggleCondition(this)">
                <span class="condition-icon">‚ù§Ô∏è</span>
                <span class="condition-name">Herz-Kreislauf</span>
            </button>
            <button class="condition-btn" data-condition="fatigue" onclick="toggleCondition(this)">
                <span class="condition-icon">üò¥</span>
                <span class="condition-name">M√ºdigkeit</span>
            </button>
        </div>
        
        <div class="location-row">
            <input type="text" class="location-input" id="location" placeholder="Ort eingeben (z.B. Z√ºrich, Schweiz)">
            <button class="gps-btn" onclick="useGPS()" title="GPS">üìç</button>
        </div>
        
        <div class="time-row">
            <span class="time-label" id="timeLabel">‚è∞ Prognose:</span>
            <select class="time-select" id="timeRange" onchange="onTimeRangeChange()">
                <option value="6">6 Stunden</option>
                <option value="12" selected>12 Stunden</option>
                <option value="24">24 Stunden</option>
                <option value="48">2 Tage</option>
                <option value="72">3 Tage</option>
            </select>
        </div>
        
        <button class="analyze-btn" onclick="analyze()" id="btnAnalyze">üîç Analyse starten</button>
    </div>
    
    <div class="container" id="results">
        <div class="loading" id="initial-msg">
            <p id="initialText">W√§hle deine Beschwerden und klicke auf "Analyse starten"</p>
        </div>
    </div>

    <script>
        const API = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://space-ai-alert-mvp.onrender.com';
        let lat = 47.3769, lon = 8.5417;
        let locationName = '';
        let currentLang = 'de';
        let selectedConditions = [];
        let currentData = null;
        let chatHistory = [];
        let selectedHourIndex = 0;
        let hourlyData = [];
        
        // Translations
        const T = {
            de: {
                tagline: "Dein pers√∂nlicher Umwelt-Gesundheitscoach",
                profileTitle: "Mein Gesundheitsprofil",
                locationPlaceholder: "Ort eingeben (z.B. Z√ºrich, Schweiz)",
                timeLabel: "‚è∞ Prognose:",
                btnAnalyze: "üîç Analyse starten",
                initialText: "W√§hle deine Beschwerden und klicke auf \"Analyse starten\"",
                analyzing: "Analysiere Umweltdaten f√ºr dein Gesundheitsprofil...",
                hours: "Stunden", days: "Tage",
                
                asthma: "Asthma", allergy: "Allergie", migraine: "Migr√§ne",
                copd: "Chron. Lungenkrankheit", cardiovascular: "Herz-Kreislauf", fatigue: "M√ºdigkeit",
                
                healthScore: "Health Impact Score",
                scoreVeryLow: "Sehr niedrig", scoreLow: "Niedrig", scoreModerate: "Moderat",
                scoreHigh: "Hoch", scoreVeryHigh: "Sehr hoch",
                
                riskLow: "Entspannter Tag",
                riskMedium: "Leichte Belastung",
                riskHigh: "Erh√∂hte Belastung",
                riskCritical: "Hohe Belastung",
                
                today: "Heute", tomorrow: "Morgen", dayAfter: "√úbermorgen",
                
                showDetails: "Details anzeigen",
                hideDetails: "Details ausblenden",
                triggers: "Aktive Trigger",
                analysisFor: "Analyse f√ºr",
                
                hourlyForecast: "St√ºndliche Prognose",
                dayForecast: "Tagesprognose",
                clickForDetails: "Klicke f√ºr Details",
                
                pm25: "PM2.5 Feinstaub", no2: "NO‚ÇÇ Stickstoffdioxid", ozone: "O‚ÇÉ Ozon",
                humidity: "Luftfeuchtigkeit", pressure: "Luftdruck", uvIndex: "UV-Index",
                
                pm25Info: "Feinstaub kann Atemwege reizen und M√ºdigkeit verst√§rken.",
                no2Info: "Stickstoffdioxid reizt die Atemwege, besonders bei Asthma.",
                ozoneInfo: "Hohe Ozonwerte k√∂nnen Kopfschmerzen und Atembeschwerden ausl√∂sen.",
                humidityInfo: "Hohe Au√üenfeuchtigkeit. Innen ist es im Winter oft zu trocken!",
                pressureInfo: "Luftdruckschwankungen k√∂nnen Migr√§ne und M√ºdigkeit ausl√∂sen.",
                uvInfo: "UV-Strahlung kann Ersch√∂pfung verst√§rken. Sonnenschutz ab Index 3.",
                
                pm25Context: "Kann M√ºdigkeit & Atembeschwerden verst√§rken",
                no2Context: "Belastet die Atemwege bei l√§ngerer Exposition",
                ozoneContext: "Kann Kopfschmerzen ausl√∂sen bei hohen Werten",
                humidityContext: "Kann M√ºdigkeit & Schweregef√ºhl verst√§rken",
                pressureContext: "Hoher Druck ‚Äì f√ºr manche Menschen belastend",
                uvContext: "Sonnenschutz empfohlen ab Index 3",
                
                whoLimit: "WHO-Grenze", euLimit: "EU-Grenze", warningLevel: "Warnschwelle",
                optimal: "Optimal", normal: "Normal", sunProtection: "Sonnenschutz ab 3",
                
                good: "Gut", moderate: "Moderat", high: "Hoch", low: "Niedrig", ok: "OK",
                
                microRecs: "Pers√∂nliche Empfehlungen",
                
                coachTitle: "HealthAir Coach",
                coachSubtitle: "Ich erkl√§re, wie Umweltfaktoren deine Symptome beeinflussen.",
                sportToday: "Sport heute?", bestTime: "Beste Zeit?", tips: "Tipps",
                
                observation: "Beobachtung",
                meaning: "Was das bedeutet",
                recommendations: "Empfehlungen",
                outlook: "Ausblick",
                
                feedbackTitle: "Hattest du heute Beschwerden?",
                feedbackSubtitle: "Dein Feedback hilft, die Vorhersagen zu verbessern.",
                feedbackYes: "üòî Ja, leider",
                feedbackNo: "üòä Nein, alles gut",
                feedbackThanks: "Danke! Dein Feedback wurde gespeichert.",
                
                premiumTitle: "‚≠ê HealthAir Premium",
                premiumFeature1: "Fr√ºhwarnungen bei erh√∂htem Risiko",
                premiumFeature2: "Lernt deine pers√∂nlichen Trigger",
                premiumFeature3: "Verlauf & Muster deiner Symptome",
                premiumFeature4: "Individuelle Tagesbriefings",
                premiumBtn: "7 Tage kostenlos testen",
                premiumNote: "Jederzeit k√ºndbar"
            },
            en: {
                tagline: "Your personal environmental health coach",
                profileTitle: "My Health Profile",
                locationPlaceholder: "Enter location (e.g. London, UK)",
                timeLabel: "‚è∞ Forecast:",
                btnAnalyze: "üîç Start Analysis",
                initialText: "Select your conditions and click \"Start Analysis\"",
                analyzing: "Analyzing environmental data for your health profile...",
                hours: "hours", days: "days",
                
                asthma: "Asthma", allergy: "Allergy", migraine: "Migraine",
                copd: "Chronic Lung Disease", cardiovascular: "Cardiovascular", fatigue: "Fatigue",
                
                healthScore: "Health Impact Score",
                scoreVeryLow: "Very Low", scoreLow: "Low", scoreModerate: "Moderate",
                scoreHigh: "High", scoreVeryHigh: "Very High",
                
                riskLow: "Relaxed day",
                riskMedium: "Mild stress",
                riskHigh: "Elevated stress",
                riskCritical: "High stress",
                
                today: "Today", tomorrow: "Tomorrow", dayAfter: "Day after",
                
                showDetails: "Show details",
                hideDetails: "Hide details",
                triggers: "Active triggers",
                analysisFor: "Analysis for",
                
                hourlyForecast: "Hourly Forecast",
                dayForecast: "Daily Forecast",
                clickForDetails: "Click for details",
                
                pm25: "PM2.5 Fine Particles", no2: "NO‚ÇÇ Nitrogen Dioxide", ozone: "O‚ÇÉ Ozone",
                humidity: "Humidity", pressure: "Air Pressure", uvIndex: "UV Index",
                
                pm25Info: "Fine particles can irritate airways and increase fatigue.",
                no2Info: "Nitrogen dioxide irritates airways, especially with asthma.",
                ozoneInfo: "High ozone can cause headaches and breathing problems.",
                humidityInfo: "High outdoor humidity. Indoors it's often too dry in winter!",
                pressureInfo: "Pressure changes can trigger migraines and fatigue.",
                uvInfo: "UV radiation can increase exhaustion. Sun protection from index 3.",
                
                pm25Context: "Can worsen fatigue & breathing issues",
                no2Context: "Stresses airways with prolonged exposure",
                ozoneContext: "Can trigger headaches at high levels",
                humidityContext: "Can increase fatigue & heaviness",
                pressureContext: "High pressure ‚Äì stressful for some people",
                uvContext: "Sun protection recommended from index 3",
                
                whoLimit: "WHO limit", euLimit: "EU limit", warningLevel: "Warning level",
                optimal: "Optimal", normal: "Normal", sunProtection: "Sun protection from 3",
                
                good: "Good", moderate: "Moderate", high: "High", low: "Low", ok: "OK",
                
                microRecs: "Personal Recommendations",
                
                coachTitle: "HealthAir Coach",
                coachSubtitle: "I explain how environmental factors affect your symptoms.",
                sportToday: "Exercise today?", bestTime: "Best time?", tips: "Tips",
                
                observation: "Observation",
                meaning: "What this means",
                recommendations: "Recommendations",
                outlook: "Outlook",
                
                feedbackTitle: "Did you have symptoms today?",
                feedbackSubtitle: "Your feedback helps improve predictions.",
                feedbackYes: "üòî Yes, unfortunately",
                feedbackNo: "üòä No, all good",
                feedbackThanks: "Thanks! Your feedback has been saved.",
                
                premiumTitle: "‚≠ê HealthAir Premium",
                premiumFeature1: "Early warnings for elevated risk",
                premiumFeature2: "Learns your personal triggers",
                premiumFeature3: "History & patterns of your symptoms",
                premiumFeature4: "Individual daily briefings",
                premiumBtn: "Try 7 days free",
                premiumNote: "Cancel anytime"
            },
            fr: {
                tagline: "Votre coach sant√© environnemental personnel",
                profileTitle: "Mon profil de sant√©",
                today: "Aujourd'hui", tomorrow: "Demain", dayAfter: "Apr√®s-demain",
                observation: "Observation", meaning: "Ce que cela signifie",
                recommendations: "Recommandations", outlook: "Perspectives",
                feedbackThanks: "Merci! Votre retour a √©t√© enregistr√©.",
                premiumTitle: "‚≠ê HealthAir Premium",
                premiumBtn: "Essai gratuit 7 jours", premiumNote: "Annulable √† tout moment"
            },
            it: {
                tagline: "Il tuo coach personale per la salute ambientale",
                profileTitle: "Il mio profilo di salute",
                today: "Oggi", tomorrow: "Domani", dayAfter: "Dopodomani",
                observation: "Osservazione", meaning: "Cosa significa",
                recommendations: "Raccomandazioni", outlook: "Prospettive",
                feedbackThanks: "Grazie! Il tuo feedback √® stato salvato.",
                premiumTitle: "‚≠ê HealthAir Premium",
                premiumBtn: "Prova gratis 7 giorni", premiumNote: "Annullabile in qualsiasi momento"
            }
        };
        
        const t = key => T[currentLang]?.[key] || T['en']?.[key] || key;
        
        // ==================== INIT ====================
        function init() {
            const savedLang = localStorage.getItem('healthair_lang');
            if (savedLang) {
                currentLang = savedLang;
                document.getElementById('language').value = savedLang;
            }
            
            const savedConditions = localStorage.getItem('healthair_conditions');
            if (savedConditions) {
                selectedConditions = JSON.parse(savedConditions);
                document.querySelectorAll('.condition-btn').forEach(btn => {
                    if (selectedConditions.includes(btn.dataset.condition)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            applyTranslations();
        }
        
        function applyTranslations() {
            document.getElementById('tagline').textContent = t('tagline');
            document.getElementById('profileTitle').textContent = t('profileTitle');
            document.getElementById('location').placeholder = t('locationPlaceholder');
            document.getElementById('timeLabel').textContent = t('timeLabel');
            document.getElementById('btnAnalyze').textContent = t('btnAnalyze');
            document.getElementById('initialText').textContent = t('initialText');
            
            document.querySelectorAll('.condition-btn').forEach(btn => {
                btn.querySelector('.condition-name').textContent = t(btn.dataset.condition);
            });
            
            const ts = document.getElementById('timeRange');
            ts.options[0].text = `6 ${t('hours')}`;
            ts.options[1].text = `12 ${t('hours')}`;
            ts.options[2].text = `24 ${t('hours')}`;
            ts.options[3].text = `2 ${t('days')}`;
            ts.options[4].text = `3 ${t('days')}`;
        }
        
        function changeLanguage() {
            currentLang = document.getElementById('language').value;
            localStorage.setItem('healthair_lang', currentLang);
            applyTranslations();
            if (currentData) renderResults(currentData);
        }
        
        function toggleCondition(btn) {
            btn.classList.toggle('active');
            const cond = btn.dataset.condition;
            if (btn.classList.contains('active')) {
                if (!selectedConditions.includes(cond)) selectedConditions.push(cond);
            } else {
                selectedConditions = selectedConditions.filter(c => c !== cond);
            }
            localStorage.setItem('healthair_conditions', JSON.stringify(selectedConditions));
        }
        
        function onTimeRangeChange() {
            if (currentData) renderResults(currentData);
        }
        
        // ==================== GEOCODING ====================
        async function geocodeLocation(query) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(query)}&format=json&limit=1&accept-language=${currentLang}`);
                const data = await res.json();
                if (data.length > 0) {
                    lat = parseFloat(data[0].lat);
                    lon = parseFloat(data[0].lon);
                    locationName = data[0].display_name.split(',').slice(0, 2).join(', ');
                    return true;
                }
            } catch (e) { console.error(e); }
            return false;
        }
        
        async function reverseGeocode(latitude, longitude) {
            try {
                const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&accept-language=${currentLang}`);
                const data = await res.json();
                const city = data.address?.city || data.address?.town || data.address?.village || '';
                const country = data.address?.country || '';
                locationName = city && country ? `${city}, ${country}` : `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
                document.getElementById('location').value = locationName;
            } catch (e) {
                locationName = `${latitude.toFixed(2)}, ${longitude.toFixed(2)}`;
            }
        }
        
        function useGPS() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    async pos => {
                        lat = pos.coords.latitude;
                        lon = pos.coords.longitude;
                        await reverseGeocode(lat, lon);
                        analyze();
                    },
                    e => alert('GPS Error: ' + e.message)
                );
            }
        }
        
        // ==================== ANALYSIS ====================
        async function analyze() {
            if (selectedConditions.length === 0) {
                alert(currentLang === 'de' ? 'Bitte w√§hle mindestens eine Beschwerde aus.' : 'Please select at least one condition.');
                return;
            }
            
            const locInput = document.getElementById('location').value.trim();
            if (locInput && locInput !== locationName) {
                const success = await geocodeLocation(locInput);
                if (!success) {
                    alert(currentLang === 'de' ? 'Ort nicht gefunden.' : 'Location not found.');
                    return;
                }
            }
            
            document.getElementById('results').innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <p>${t('analyzing')}</p>
                </div>
            `;
            
            try {
                const res = await fetch(`${API}/data/?lat=${lat}&lon=${lon}`);
                const data = await res.json();
                currentData = data;
                selectedHourIndex = 0;
                renderResults(data);
                fetchChat();
            } catch (e) {
                document.getElementById('results').innerHTML = `<div class="loading">‚ùå Error: ${e.message}</div>`;
            }
        }
        
        // ==================== HEALTH SCORE ====================
        function calculateHealthScore(data, hourOffset = 0) {
            let score = 0;
            const triggers = [];
            const air = data.air_quality || {};
            const weather = data.weather || {};
            
            // Simulate variation based on hour
            const variation = Math.sin(hourOffset * 0.3) * 10;
            
            const pm25 = (air.pm2_5 || 0) + variation * 0.5;
            if (pm25 > 35) { score += 25; triggers.push({ name: 'PM2.5', value: pm25.toFixed(1), unit: 'Œºg/m¬≥', severity: 'high' }); }
            else if (pm25 > 15) { score += 12; triggers.push({ name: 'PM2.5', value: pm25.toFixed(1), unit: 'Œºg/m¬≥', severity: 'medium' }); }
            else if (pm25 > 10) { score += 5; }
            
            const no2 = (air.no2 || 0) + variation * 0.3;
            if (no2 > 100) { score += 20; triggers.push({ name: 'NO‚ÇÇ', value: no2.toFixed(1), unit: 'Œºg/m¬≥', severity: 'high' }); }
            else if (no2 > 40) { score += 10; triggers.push({ name: 'NO‚ÇÇ', value: no2.toFixed(1), unit: 'Œºg/m¬≥', severity: 'medium' }); }
            
            const ozone = (air.ozone || 0) + variation * 0.4;
            if (ozone > 180) { score += 15; triggers.push({ name: 'Ozon', value: ozone.toFixed(1), unit: 'Œºg/m¬≥', severity: 'high' }); }
            else if (ozone > 100) { score += 8; }
            
            const humidity = weather.humidity || 0;
            if (humidity > 85) { score += 15; triggers.push({ name: t('humidity'), value: humidity, unit: '%', severity: 'high' }); }
            else if (humidity > 70) { score += 8; }
            else if (humidity < 30) { score += 10; }
            
            const pressure = weather.pressure || 1013;
            if (pressure < 1000 || pressure > 1030) { score += 10; triggers.push({ name: t('pressure'), value: pressure, unit: 'hPa', severity: 'medium' }); }
            else if (pressure < 1005 || pressure > 1025) { score += 5; }
            
            const uv = air.uv_index || 0;
            if (uv >= 8) { score += 15; triggers.push({ name: 'UV', value: uv, unit: '', severity: 'high' }); }
            else if (uv >= 6) { score += 8; }
            else if (uv >= 3) { score += 3; }
            
            score = Math.max(0, Math.min(100, Math.round(score + variation)));
            
            let level, levelKey, riskClass;
            if (score <= 20) { level = t('scoreVeryLow'); levelKey = 'low'; riskClass = 'risk-low'; }
            else if (score <= 40) { level = t('scoreLow'); levelKey = 'low'; riskClass = 'risk-low'; }
            else if (score <= 60) { level = t('scoreModerate'); levelKey = 'medium'; riskClass = 'risk-medium'; }
            else if (score <= 80) { level = t('scoreHigh'); levelKey = 'high'; riskClass = 'risk-high'; }
            else { level = t('scoreVeryHigh'); levelKey = 'critical'; riskClass = 'risk-critical'; }
            
            return { score, level, levelKey, riskClass, triggers };
        }
        
        // ==================== RENDER ====================
        function renderResults(data) {
            const health = calculateHealthScore(data, selectedHourIndex);
            const air = data.air_quality || {};
            const weather = data.weather || {};
            const timeRange = parseInt(document.getElementById('timeRange').value);
            
            const scoreColor = health.score <= 20 ? '#10b981' : 
                              health.score <= 40 ? '#84cc16' :
                              health.score <= 60 ? '#f59e0b' :
                              health.score <= 80 ? '#f97316' : '#ef4444';
            
            // Generate hourly data
            hourlyData = [];
            const now = new Date();
            for (let i = 0; i < Math.min(timeRange, 72); i++) {
                const h = new Date(now.getTime() + i * 3600000);
                const hourHealth = calculateHealthScore(data, i);
                hourlyData.push({
                    date: h,
                    hour: h.getHours(),
                    score: hourHealth.score,
                    level: hourHealth.levelKey,
                    triggers: hourHealth.triggers
                });
            }
            
            // Prognosis text - more emotional
            const conditionNames = selectedConditions.map(c => t(c)).join(' & ');
            const mainTrigger = health.triggers[0];
            
            let prognosisMain, prognosisRec;
            if (health.levelKey === 'low') {
                prognosisMain = currentLang === 'de' 
                    ? `Heute ein entspannter Tag f√ºr deine ${conditionNames}. Die Luftqualit√§t ist stabil, Reizstoffe sind niedrig.`
                    : `A relaxed day for your ${conditionNames}. Air quality is stable, irritants are low.`;
                prognosisRec = currentLang === 'de'
                    ? `Ideale Bedingungen f√ºr Aktivit√§ten im Freien.`
                    : `Ideal conditions for outdoor activities.`;
            } else if (health.levelKey === 'medium') {
                prognosisMain = currentLang === 'de'
                    ? `Leichte Belastung f√ºr ${conditionNames} m√∂glich.`
                    : `Mild stress for ${conditionNames} possible.`;
                prognosisRec = mainTrigger 
                    ? (currentLang === 'de' 
                        ? `Hauptfaktor: ${mainTrigger.name} (${mainTrigger.value}${mainTrigger.unit}). Beobachte deine Symptome.`
                        : `Main factor: ${mainTrigger.name} (${mainTrigger.value}${mainTrigger.unit}). Monitor your symptoms.`)
                    : '';
            } else {
                prognosisMain = currentLang === 'de'
                    ? `Erh√∂hte Belastung f√ºr ${conditionNames} heute.`
                    : `Elevated stress for ${conditionNames} today.`;
                prognosisRec = mainTrigger
                    ? (currentLang === 'de'
                        ? `Hauptfaktor: ${mainTrigger.name} (${mainTrigger.value}${mainTrigger.unit}). Intensive Outdoor-Aktivit√§ten meiden.`
                        : `Main factor: ${mainTrigger.name} (${mainTrigger.value}${mainTrigger.unit}). Avoid intense outdoor activities.`)
                    : '';
            }
            
            // Timeline HTML - hourly or daily based on timeRange
            let timelineHtml;
            if (timeRange <= 24) {
                timelineHtml = renderHourlyTimeline(hourlyData);
            } else {
                timelineHtml = renderDayCards(hourlyData);
            }
            
            // Selected hour info
            const selectedHour = hourlyData[selectedHourIndex] || hourlyData[0];
            const selectedTimeStr = selectedHour ? 
                `${selectedHour.hour.toString().padStart(2, '0')}:00` : 'Jetzt';
            
            const microRecs = generateMicroRecs(data, health);
            
            document.getElementById('results').innerHTML = `
                <!-- Health Score -->
                <div class="health-score-card">
                    <div class="score-header">${t('healthScore')}</div>
                    <div class="score-circle" style="--score-pct: ${health.score}; --score-color: ${scoreColor}">
                        <div class="score-value" style="color: ${scoreColor}">${health.score}</div>
                        <div class="score-max">/100</div>
                    </div>
                    <div class="score-label" style="color: ${scoreColor}">${health.level}</div>
                    <div class="score-location">üìç ${locationName || 'Z√ºrich, Schweiz'}</div>
                    <div class="health-bar">
                        <div class="health-bar-marker" style="left: ${health.score}%"></div>
                    </div>
                    <div class="health-bar-labels">
                        <span>0</span><span>25</span><span>50</span><span>75</span><span>100</span>
                    </div>
                </div>
                
                <!-- Prognosis -->
                <div class="prognosis-card ${health.riskClass}">
                    <div class="prognosis-header">
                        <span class="prognosis-icon">${health.levelKey === 'low' ? '‚úÖ' : health.levelKey === 'medium' ? '‚ö†Ô∏è' : 'üî¥'}</span>
                        <span class="prognosis-title">${t('risk' + health.levelKey.charAt(0).toUpperCase() + health.levelKey.slice(1))}</span>
                    </div>
                    <div class="prognosis-main">${prognosisMain}</div>
                    <div class="prognosis-recommendation">
                        <strong>‚Üí</strong> ${prognosisRec}
                    </div>
                    ${health.triggers.length > 0 ? `
                        <div class="prognosis-details">
                            <div class="prognosis-toggle" onclick="toggleDetails(this)">
                                <span>‚ñ∂</span> ${t('showDetails')}
                            </div>
                            <div class="prognosis-expanded">
                                <strong>${t('triggers')}:</strong>
                                <div class="trigger-list">
                                    ${health.triggers.map(tr => `
                                        <span class="trigger-chip ${tr.severity === 'high' ? 'high' : ''}">${tr.name}: ${tr.value}${tr.unit}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Timeline -->
                ${timelineHtml}
                
                <!-- Trigger Cards -->
                <div class="triggers-grid">
                    ${renderTriggerCard('pm25', 'üå´Ô∏è', air.pm2_5, 'Œºg/m¬≥', 15, 35, t('whoLimit') + ': 15', t('pm25Context'))}
                    ${renderTriggerCard('no2', 'üè≠', air.no2, 'Œºg/m¬≥', 40, 100, t('euLimit') + ': 40', t('no2Context'))}
                    ${renderTriggerCard('ozone', '‚òÄÔ∏è', air.ozone, 'Œºg/m¬≥', 100, 180, t('warningLevel') + ': 180', t('ozoneContext'))}
                    ${renderTriggerCard('humidity', 'üíß', weather.humidity, '%', 60, 85, t('optimal') + ': 40-60%', t('humidityContext'))}
                    ${renderTriggerCard('pressure', 'üå°Ô∏è', weather.pressure, 'hPa', 1005, 1025, t('normal') + ': 1013', t('pressureContext'), true)}
                    ${renderTriggerCard('uvIndex', 'üåû', air.uv_index, '', 3, 6, t('sunProtection'), t('uvContext'))}
                </div>
                
                <!-- Micro Recommendations -->
                <div class="micro-recs">
                    <div class="micro-recs-title">üí° ${t('microRecs')}</div>
                    ${microRecs.map(rec => `
                        <div class="micro-rec-item">
                            <span class="micro-rec-icon">${rec.icon}</span>
                            <span class="micro-rec-text">${rec.text}</span>
                        </div>
                    `).join('')}
                </div>
                
                <!-- Chat -->
                <div class="chat-card">
                    <div class="chat-header">
                        <div class="chat-avatar">ü§ñ</div>
                        <div class="chat-header-text">
                            <h3>${t('coachTitle')}</h3>
                            <p>${t('coachSubtitle')}</p>
                        </div>
                    </div>
                    <div class="chat-quick-btns">
                        <button class="chat-quick-btn" onclick="askQuestion('${t('sportToday')}')">üèÉ ${t('sportToday')}</button>
                        <button class="chat-quick-btn" onclick="askQuestion('${t('bestTime')}')">‚è∞ ${t('bestTime')}</button>
                        <button class="chat-quick-btn" onclick="askQuestion('${t('tips')}')">üí° ${t('tips')}</button>
                    </div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-row">
                        <input type="text" class="chat-input" id="chat-input" placeholder="Frage stellen..." onkeypress="if(event.key==='Enter')sendChat()">
                        <button class="chat-send" onclick="sendChat()">‚Üí</button>
                    </div>
                </div>
                
                <!-- Feedback -->
                <div class="feedback-card" id="feedback-card">
                    <div class="feedback-title">${t('feedbackTitle')}</div>
                    <div class="feedback-subtitle">${t('feedbackSubtitle')}</div>
                    <div class="feedback-btns">
                        <button class="feedback-btn yes" onclick="submitFeedback(true)">${t('feedbackYes')}</button>
                        <button class="feedback-btn no" onclick="submitFeedback(false)">${t('feedbackNo')}</button>
                    </div>
                </div>
                
                <!-- Premium -->
                <div class="premium-banner">
                    <div class="premium-title">${t('premiumTitle')}</div>
                    <div class="premium-features">
                        <div class="premium-feature"><span class="premium-feature-icon">üîî</span> ${t('premiumFeature1')}</div>
                        <div class="premium-feature"><span class="premium-feature-icon">üß†</span> ${t('premiumFeature2')}</div>
                        <div class="premium-feature"><span class="premium-feature-icon">üìä</span> ${t('premiumFeature3')}</div>
                        <div class="premium-feature"><span class="premium-feature-icon">üì¨</span> ${t('premiumFeature4')}</div>
                    </div>
                    <a href="#" class="premium-btn">${t('premiumBtn')}</a>
                    <div class="premium-note">${t('premiumNote')}</div>
                </div>
            `;
            
            renderChat();
        }
        
        function renderHourlyTimeline(data) {
            const now = new Date();
            let hoursHtml = data.map((h, i) => {
                const hourStr = h.hour.toString().padStart(2, '0') + ':00';
                const dateStr = h.date.getDate() !== now.getDate() ? 
                    h.date.toLocaleDateString(currentLang, { day: 'numeric', month: 'short' }) : '';
                
                const riskIcon = h.score <= 30 ? '‚úì' : h.score <= 60 ? '‚ö°' : '‚ö†Ô∏è';
                const isNow = i === 0;
                const isSelected = i === selectedHourIndex;
                
                // Trend
                let trend = '', trendClass = '';
                if (i > 0) {
                    const diff = h.score - data[i-1].score;
                    if (diff > 5) { trend = '‚Üë'; trendClass = 'trend-up'; }
                    else if (diff < -5) { trend = '‚Üì'; trendClass = 'trend-down'; }
                    else { trend = '‚Üí'; trendClass = 'trend-stable'; }
                }
                
                return `
                    <div class="timeline-hour ${isNow ? 'now' : ''} ${isSelected ? 'selected' : ''}" onclick="selectHour(${i})">
                        <div class="time">${hourStr}</div>
                        ${dateStr ? `<div class="date">${dateStr}</div>` : ''}
                        <div class="risk-indicator">${riskIcon}</div>
                        ${trend ? `<div class="trend ${trendClass}">${trend}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            return `
                <div class="timeline-card">
                    <div class="timeline-header">
                        <span class="timeline-title">üìä ${t('hourlyForecast')}</span>
                        <div class="timeline-nav">
                            <button class="timeline-nav-btn" onclick="scrollTimeline(-1)">‚óÄ</button>
                            <button class="timeline-nav-btn" onclick="scrollTimeline(1)">‚ñ∂</button>
                        </div>
                    </div>
                    <div class="timeline-scroll" id="timeline-scroll">${hoursHtml}</div>
                    <div style="text-align:center;margin-top:8px;font-size:0.8rem;color:var(--text-dim);">
                        ${t('clickForDetails')}
                    </div>
                </div>
            `;
        }
        
        function renderDayCards(data) {
            // Group by day
            const days = [];
            let currentDay = null;
            
            data.forEach((h, i) => {
                const dayKey = h.date.toDateString();
                if (dayKey !== currentDay) {
                    currentDay = dayKey;
                    days.push({
                        date: h.date,
                        hours: [h],
                        avgScore: h.score
                    });
                } else {
                    days[days.length - 1].hours.push(h);
                }
            });
            
            // Calculate avg score per day
            days.forEach(d => {
                d.avgScore = Math.round(d.hours.reduce((sum, h) => sum + h.score, 0) / d.hours.length);
                d.level = d.avgScore <= 30 ? 'low' : d.avgScore <= 60 ? 'medium' : d.avgScore <= 80 ? 'high' : 'critical';
                d.riskLabel = d.level === 'low' ? t('good') : d.level === 'medium' ? t('moderate') : t('high');
            });
            
            const dayNames = [t('today'), t('tomorrow'), t('dayAfter')];
            
            let daysHtml = days.slice(0, 3).map((d, i) => {
                const dayName = i < 3 ? dayNames[i] : d.date.toLocaleDateString(currentLang, { weekday: 'long' });
                const levelIcon = d.level === 'low' ? 'üü¢' : d.level === 'medium' ? 'üü°' : 'üî¥';
                
                return `
                    <div class="day-card" onclick="toggleDayCard(this)" data-day="${i}">
                        <div class="day-card-main">
                            <span class="day-card-name">${dayName}</span>
                            <span class="day-card-risk ${d.level}">${levelIcon} ${d.riskLabel}</span>
                            <span class="day-card-summary">Score: ${d.avgScore}/100</span>
                            <span class="day-card-expand">‚ñº</span>
                        </div>
                        <div class="day-card-hours">
                            <div class="timeline-scroll">
                                ${d.hours.slice(0, 12).map((h, hi) => `
                                    <div class="timeline-hour" onclick="event.stopPropagation(); selectHour(${data.indexOf(h)})">
                                        <div class="time">${h.hour.toString().padStart(2, '0')}:00</div>
                                        <div class="risk-indicator">${h.score <= 30 ? '‚úì' : h.score <= 60 ? '‚ö°' : '‚ö†Ô∏è'}</div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            return `
                <div class="timeline-card">
                    <div class="timeline-header">
                        <span class="timeline-title">üìÖ ${t('dayForecast')}</span>
                    </div>
                    <div class="day-cards">${daysHtml}</div>
                </div>
            `;
        }
        
        function selectHour(index) {
            selectedHourIndex = index;
            renderResults(currentData);
        }
        
        function toggleDayCard(el) {
            el.classList.toggle('expanded');
        }
        
        function renderTriggerCard(key, icon, value, unit, goodThreshold, badThreshold, limitText, contextText, invertLogic = false) {
            const val = value ?? 0;
            let badgeClass, badgeText;
            
            if (invertLogic) {
                const diff = Math.abs(val - 1013);
                if (diff <= 10) { badgeClass = 'badge-good'; badgeText = t('good'); }
                else if (diff <= 20) { badgeClass = 'badge-moderate'; badgeText = t('moderate'); }
                else { badgeClass = 'badge-high'; badgeText = t('high'); }
            } else {
                if (val <= goodThreshold) { badgeClass = 'badge-good'; badgeText = t('good'); }
                else if (val <= badThreshold) { badgeClass = 'badge-moderate'; badgeText = t('moderate'); }
                else { badgeClass = 'badge-bad'; badgeText = t('high'); }
            }
            
            return `
                <div class="trigger-card">
                    <div class="info-popup" id="info-${key}">
                        ${t(key + 'Info')}
                        <button class="info-popup-close" onclick="event.stopPropagation();hideInfo('${key}')">‚úï</button>
                    </div>
                    <div class="trigger-card-header">
                        <span class="trigger-card-title">${icon} ${t(key)}</span>
                        <button class="info-btn" onclick="event.stopPropagation();showInfo('${key}')">i</button>
                    </div>
                    <div class="trigger-card-value">${val.toFixed(1)}<span class="trigger-card-unit">${unit}</span></div>
                    <span class="trigger-card-badge ${badgeClass}">${badgeText}</span>
                    <div class="trigger-card-limit">${limitText}</div>
                    <div class="trigger-card-context">${contextText}</div>
                </div>
            `;
        }
        
        function generateMicroRecs(data, health) {
            const recs = [];
            const weather = data.weather || {};
            const air = data.air_quality || {};
            const now = new Date();
            const hour = now.getHours();
            
            if (selectedConditions.includes('fatigue') && weather.humidity > 80) {
                recs.push({
                    icon: 'üíß',
                    text: currentLang === 'de' 
                        ? `Hohe Au√üenfeuchtigkeit (${weather.humidity}%) ‚Äì <span class="micro-rec-highlight">trinke heute 2 Gl√§ser mehr Wasser</span>.`
                        : `High outdoor humidity (${weather.humidity}%) ‚Äì <span class="micro-rec-highlight">drink 2 extra glasses of water</span>.`
                });
            }
            
            if ((selectedConditions.includes('asthma') || selectedConditions.includes('copd')) && air.pm2_5 > 15) {
                recs.push({
                    icon: 'ü´Å',
                    text: currentLang === 'de'
                        ? `PM2.5 erh√∂ht ‚Äì <span class="micro-rec-highlight">Fenster geschlossen halten</span>, Notfall-Spray bereithalten.`
                        : `PM2.5 elevated ‚Äì <span class="micro-rec-highlight">keep windows closed</span>, have rescue inhaler ready.`
                });
            }
            
            // Best time
            const bestHour = hourlyData.reduce((best, h, i) => h.score < hourlyData[best].score ? i : best, 0);
            const bestTime = hourlyData[bestHour]?.hour;
            if (bestTime !== undefined) {
                recs.push({
                    icon: '‚è∞',
                    text: currentLang === 'de'
                        ? `Beste Zeit f√ºr Aktivit√§ten: <span class="micro-rec-highlight">${bestTime}:00 - ${(bestTime+2)%24}:00</span>.`
                        : `Best time for activities: <span class="micro-rec-highlight">${bestTime}:00 - ${(bestTime+2)%24}:00</span>.`
                });
            }
            
            if (air.uv_index >= 3) {
                recs.push({
                    icon: 'üß¥',
                    text: currentLang === 'de'
                        ? `UV-Index ${air.uv_index} ‚Äì <span class="micro-rec-highlight">Sonnenschutz LSF 30+</span> verwenden.`
                        : `UV Index ${air.uv_index} ‚Äì use <span class="micro-rec-highlight">SPF 30+ sunscreen</span>.`
                });
            }
            
            if (recs.length === 0) {
                recs.push({
                    icon: '‚ú®',
                    text: currentLang === 'de'
                        ? `Ideale Bedingungen ‚Äì <span class="micro-rec-highlight">genie√üe den Tag!</span>`
                        : `Ideal conditions ‚Äì <span class="micro-rec-highlight">enjoy your day!</span>`
                });
            }
            
            return recs.slice(0, 4);
        }
        
        function toggleDetails(el) {
            const expanded = el.parentElement.querySelector('.prognosis-expanded');
            const isShown = expanded.classList.toggle('show');
            el.innerHTML = isShown 
                ? `<span>‚ñº</span> ${t('hideDetails')}`
                : `<span>‚ñ∂</span> ${t('showDetails')}`;
        }
        
        function scrollTimeline(dir) {
            const scroll = document.getElementById('timeline-scroll');
            if (scroll) scroll.scrollBy({ left: dir * 200, behavior: 'smooth' });
        }
        
        function showInfo(key) { document.getElementById('info-' + key).classList.add('show'); }
        function hideInfo(key) { document.getElementById('info-' + key).classList.remove('show'); }
        
        function submitFeedback(hadSymptoms) {
            const feedback = {
                date: new Date().toISOString(),
                conditions: selectedConditions,
                hadSymptoms,
                score: currentData ? calculateHealthScore(currentData).score : null,
                location: locationName
            };
            const history = JSON.parse(localStorage.getItem('healthair_feedback') || '[]');
            history.push(feedback);
            localStorage.setItem('healthair_feedback', JSON.stringify(history.slice(-100)));
            
            document.getElementById('feedback-card').innerHTML = `
                <div class="feedback-thanks">‚úì ${t('feedbackThanks')}</div>
            `;
        }
        
        // ==================== CHAT ====================
        function getHealthProfile() {
            const profileMap = {
                asthma: 'Asthma', allergy: 'Allergy', migraine: 'Migraine',
                copd: 'COPD/Respiratory', cardiovascular: 'Cardiovascular', fatigue: 'Fatigue/Sleep'
            };
            return selectedConditions.map(c => profileMap[c] || c).join(', ') || 'General Health';
        }
        
        async function fetchChat() {
            const condNames = selectedConditions.map(c => t(c)).join(', ');
            const prompt = currentLang === 'de'
                ? `WICHTIG: Der Nutzer hat NUR diese Beschwerden: ${condNames}. 

Antworte STRUKTURIERT in diesem Format:
**Beobachtung:** (1-2 Bullet Points zu den wichtigsten Umweltfaktoren)
**Was das bedeutet:** (1-2 kurze S√§tze zur Auswirkung)
**Empfehlungen:** (2-3 konkrete Bullet Points)
**Ausblick:** (1 Satz zur Entwicklung)

Sei pr√§zise und nutze Emojis.`
                : `IMPORTANT: The user ONLY has these conditions: ${condNames}.

Answer STRUCTURED in this format:
**Observation:** (1-2 bullet points on key environmental factors)
**What this means:** (1-2 short sentences on impact)
**Recommendations:** (2-3 concrete bullet points)
**Outlook:** (1 sentence on development)

Be precise and use emojis.`;
            
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(getHealthProfile())}&language=${currentLang}&question=${encodeURIComponent(prompt)}`, { method: 'POST' });
                const data = await res.json();
                chatHistory = [{ role: 'ai', text: data.answer, structured: true }];
                renderChat();
            } catch (e) { console.error(e); }
        }
        
        function renderChat() {
            const el = document.getElementById('chat-messages');
            if (!el) return;
            
            el.innerHTML = chatHistory.map(m => {
                if (m.role === 'user') {
                    return `<div class="chat-msg chat-user">${m.text}</div>`;
                } else {
                    // Try to parse structured response
                    const text = m.text;
                    if (text.includes('**') || text.includes('Beobachtung') || text.includes('Observation')) {
                        return renderStructuredResponse(text);
                    }
                    return `<div class="chat-msg chat-ai">ü§ñ ${text}</div>`;
                }
            }).join('');
            el.scrollTop = el.scrollHeight;
        }
        
        function renderStructuredResponse(text) {
            // Parse markdown-style sections
            const sections = [];
            const patterns = [
                { key: 'observation', regex: /\*?\*?Beobachtung\*?\*?:?\s*([\s\S]*?)(?=\*?\*?Was|$)/i },
                { key: 'meaning', regex: /\*?\*?Was das bedeutet\*?\*?:?\s*([\s\S]*?)(?=\*?\*?Empfehlung|$)/i },
                { key: 'recommendations', regex: /\*?\*?Empfehlung(?:en)?\*?\*?:?\s*([\s\S]*?)(?=\*?\*?Ausblick|$)/i },
                { key: 'outlook', regex: /\*?\*?Ausblick\*?\*?:?\s*([\s\S]*?)$/i }
            ];
            
            patterns.forEach(p => {
                const match = text.match(p.regex);
                if (match && match[1].trim()) {
                    sections.push({ key: p.key, content: match[1].trim() });
                }
            });
            
            if (sections.length === 0) {
                return `<div class="chat-msg chat-ai">ü§ñ ${text}</div>`;
            }
            
            const icons = { observation: 'üëÅÔ∏è', meaning: 'üí°', recommendations: '‚úÖ', outlook: 'üîÆ' };
            
            return `
                <div class="coach-response">
                    ${sections.map(s => `
                        <div class="coach-section">
                            <div class="coach-section-title">${icons[s.key] || 'üìå'} ${t(s.key)}</div>
                            <div class="coach-section-content">${formatContent(s.content)}</div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        function formatContent(content) {
            // Convert bullet points and clean up
            return content
                .replace(/\*\*/g, '')
                .replace(/^\s*[-‚Ä¢]\s*/gm, '<li>')
                .replace(/(<li>.*?)(?=<li>|$)/gs, '$1</li>')
                .replace(/(<li>.*<\/li>)+/gs, '<ul>$&</ul>')
                .replace(/\n/g, ' ')
                .trim();
        }
        
        function askQuestion(q) {
            document.getElementById('chat-input').value = q;
            sendChat();
        }
        
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const q = input.value.trim();
            if (!q) return;
            
            chatHistory.push({ role: 'user', text: q });
            renderChat();
            input.value = '';
            
            const condNames = selectedConditions.map(c => t(c)).join(', ');
            const context = currentLang === 'de'
                ? `WICHTIG: Ich habe NUR diese Beschwerden: ${condNames}. Antworte kurz und strukturiert mit Bullet Points.`
                : `IMPORTANT: I ONLY have these conditions: ${condNames}. Answer briefly with bullet points.`;
            
            const el = document.getElementById('chat-messages');
            el.innerHTML += `<div class="chat-msg chat-ai" id="typing">üí≠ ...</div>`;
            el.scrollTop = el.scrollHeight;
            
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(getHealthProfile())}&language=${currentLang}&question=${encodeURIComponent(context + '\n\n' + q)}`, { method: 'POST' });
                const data = await res.json();
                document.getElementById('typing')?.remove();
                chatHistory.push({ role: 'ai', text: data.answer });
                renderChat();
            } catch (e) {
                document.getElementById('typing')?.remove();
                chatHistory.push({ role: 'ai', text: '‚ùå Error: ' + e.message });
                renderChat();
            }
        }
        
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
