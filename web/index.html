<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåç Environmental Monitor</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --bg: #0a0a1a;
            --card: rgba(255,255,255,0.03);
            --border: rgba(255,255,255,0.08);
            --text: #e4e4e4;
            --dim: #888;
            --accent: #00d4ff;
            --accent2: #7b2cbf;
            --success: #00ff88;
            --warning: #ffc107;
            --danger: #ff5733;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg) 0%, #16213e 50%, #0f3460 100%);
            min-height: 100vh;
            color: var(--text);
            padding: 12px;
        }
        .container { max-width: 1600px; margin: 0 auto; }
        
        header {
            text-align: center;
            padding: 16px;
            background: var(--card);
            border-radius: 16px;
            margin-bottom: 16px;
            border: 1px solid var(--border);
        }
        h1 {
            font-size: 1.6rem;
            background: linear-gradient(90deg, var(--accent), var(--accent2));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { color: var(--dim); margin-top: 4px; font-size: 0.75rem; }
        .satellite-badges { margin-top: 8px; }
        .satellite-badge {
            display: inline-block;
            background: rgba(0,212,255,0.15);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.6rem;
            margin: 2px;
        }
        .ai-badge {
            display: inline-block;
            background: linear-gradient(90deg, #10b981, #059669);
            color: white;
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-top: 6px;
        }
        
        .section-box {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .section-header {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--accent);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }
        
        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            justify-content: center;
            align-items: flex-end;
        }
        .control-group { display: flex; flex-direction: column; gap: 3px; }
        .control-group label { font-size: 0.65rem; color: var(--dim); text-transform: uppercase; }
        input, select {
            padding: 8px 10px;
            border: 1px solid var(--border);
            border-radius: 8px;
            background: rgba(0,0,0,0.4);
            color: #fff;
            font-size: 0.85rem;
            min-width: 100px;
        }
        button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn-primary { background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; }
        .btn-primary:hover { transform: translateY(-1px); }
        .btn-secondary { background: rgba(255,255,255,0.1); color: #fff; }
        
        .ai-box {
            background: linear-gradient(135deg, rgba(16,185,129,0.08), rgba(5,150,105,0.08));
            border: 1px solid rgba(16,185,129,0.3);
            border-radius: 12px;
            padding: 16px;
            margin-top: 12px;
        }
        .ai-recommendation { font-size: 1rem; line-height: 1.6; color: #fff; }
        .ai-meta {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 8px;
        }
        .ai-source { font-size: 0.7rem; color: var(--dim); }
        
        .risk-badge { padding: 4px 12px; border-radius: 16px; font-weight: 700; font-size: 0.75rem; }
        .risk-low { background: rgba(0,255,136,0.15); color: var(--success); }
        .risk-medium { background: rgba(255,193,7,0.18); color: var(--warning); }
        .risk-high { background: rgba(255,87,51,0.18); color: var(--danger); }
        .risk-critical { background: rgba(255,0,0,0.25); color: #ff4444; }
        
        .risk-factors { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 8px; }
        .risk-factor {
            background: rgba(255,193,7,0.15);
            border: 1px solid rgba(255,193,7,0.3);
            padding: 4px 10px;
            border-radius: 8px;
            font-size: 0.75rem;
            color: var(--warning);
        }
        .risk-factor.severe { background: rgba(255,87,51,0.15); border-color: rgba(255,87,51,0.3); color: var(--danger); }
        
        .chat-messages {
            max-height: 300px;
            overflow-y: auto;
            margin-bottom: 12px;
            padding: 8px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            min-height: 80px;
        }
        .chat-message { padding: 10px 14px; border-radius: 12px; margin-bottom: 8px; font-size: 0.85rem; line-height: 1.5; }
        .chat-user { background: rgba(0,212,255,0.15); border: 1px solid rgba(0,212,255,0.3); margin-left: 20%; text-align: right; }
        .chat-ai { background: rgba(16,185,129,0.15); border: 1px solid rgba(16,185,129,0.3); margin-right: 10%; }
        .chat-ai-initial { background: rgba(123,44,191,0.15); border: 1px solid rgba(123,44,191,0.3); }
        .chat-input-row { display: flex; gap: 8px; }
        .chat-input { flex: 1; padding: 10px 14px; border: 1px solid var(--border); border-radius: 20px; background: rgba(0,0,0,0.3); color: #fff; font-size: 0.85rem; }
        .chat-send { padding: 10px 20px; border-radius: 20px; background: linear-gradient(135deg, var(--accent), var(--accent2)); color: white; border: none; font-weight: 600; cursor: pointer; }
        .chat-header { display: flex; justify-content: space-between; align-items: center; }
        .chat-clear { font-size: 0.7rem; color: var(--dim); cursor: pointer; }
        .chat-clear:hover { color: var(--danger); }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 10px; }
        .card {
            background: var(--card);
            border-radius: 12px;
            padding: 12px;
            border: 1px solid var(--border);
        }
        .card-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 8px;
            padding-bottom: 6px;
            border-bottom: 1px solid var(--border);
        }
        .card-icon { font-size: 1rem; }
        .card-title { font-size: 0.8rem; font-weight: 600; flex: 1; }
        .source-badge {
            font-size: 0.5rem;
            padding: 2px 5px;
            border-radius: 4px;
            background: rgba(0,212,255,0.1);
            color: var(--accent);
        }
        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 0;
            border-bottom: 1px solid rgba(255,255,255,0.02);
        }
        .metric:last-child { border-bottom: none; }
        .metric-label { color: var(--dim); font-size: 0.7rem; }
        .metric-value { font-weight: 600; font-size: 0.75rem; }
        
        .badge { padding: 2px 6px; border-radius: 6px; font-size: 0.6rem; font-weight: 600; }
        .badge-good { background: rgba(0,255,136,0.12); color: var(--success); }
        .badge-moderate { background: rgba(255,193,7,0.12); color: var(--warning); }
        .badge-bad { background: rgba(255,87,51,0.12); color: var(--danger); }
        
        .data-section-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--accent);
            margin: 12px 0 8px 0;
            padding-bottom: 4px;
            border-bottom: 1px solid var(--border);
        }
        
        .loading { text-align: center; padding: 20px; color: var(--dim); }
        .loading::after {
            content: '';
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid rgba(0,212,255,0.3);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-left: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        footer { text-align: center; padding: 16px; color: #444; font-size: 0.65rem; margin-top: 16px; }
        
        @media (max-width: 768px) {
            .grid { grid-template-columns: 1fr 1fr; }
            .controls { flex-direction: column; align-items: stretch; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üåç Environmental Monitor</h1>
            <p class="subtitle" id="subtitle">Complete Edition - 15+ Satellitendatenquellen</p>
            <div class="satellite-badges">
                <span class="satellite-badge">GOES-16/18</span>
                <span class="satellite-badge">DSCOVR</span>
                <span class="satellite-badge">VIIRS</span>
                <span class="satellite-badge">Sentinel-5P</span>
            </div>
            <span class="ai-badge">‚ú® KI: Qwen 72B</span>
        </header>
        
        <div class="section-box">
            <div class="section-header">üìä <span id="inputsTitle">Standort & Einstellungen</span></div>
            <div class="controls">
                <div class="control-group">
                    <label id="latLabel">Breitengrad</label>
                    <input type="number" id="lat" value="47.3769" step="0.0001">
                </div>
                <div class="control-group">
                    <label id="lonLabel">L√§ngengrad</label>
                    <input type="number" id="lon" value="8.5417" step="0.0001">
                </div>
                <div class="control-group">
                    <label id="profileLabel">Profil</label>
                    <select id="profile">
                        <option value="General Public">Allgemein</option>
                        <option value="Outdoor/Sports">Outdoor/Sport</option>
                        <option value="Asthma/Respiratory">Asthma/Atemwege</option>
                        <option value="Allergy">Allergie</option>
                        <option value="Pilot/Aviation">Pilot/Luftfahrt</option>
                        <option value="Aurora Hunter">Aurora/Nordlichter</option>
                        <option value="Marine/Sailing">Marine/Segeln</option>
                    </select>
                </div>
                <div class="control-group">
                    <label id="langLabel">Sprache</label>
                    <select id="language" onchange="changeLanguage()">
                        <option value="de">üá©üá™ Deutsch</option>
                        <option value="en">üá¨üáß English</option>
                        <option value="fr">üá´üá∑ Fran√ßais</option>
                        <option value="it">üáÆüáπ Italiano</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="fetchAlert()">üîç <span id="btnGet">Empfehlung holen</span></button>
                <button class="btn-secondary" onclick="useMyLocation()">üìç <span id="btnLoc">Mein Standort</span></button>
            </div>
            <div id="ai-container"></div>
        </div>
        
        <div class="section-box">
            <div class="chat-header">
                <div class="section-header" style="margin-bottom:0;border-bottom:none;padding-bottom:0;">üí¨ <span id="chatTitle">KI-Assistent</span></div>
                <span class="chat-clear" onclick="clearChat()" id="clearChat">Verlauf l√∂schen</span>
            </div>
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-row">
                <input type="text" class="chat-input" id="chat-input" placeholder="z.B. Kann ich heute joggen?" onkeypress="if(event.key==='Enter')sendChat()">
                <button class="chat-send" onclick="sendChat()" id="btnSend">Senden</button>
            </div>
        </div>
        
        <div class="section-box">
            <div class="section-header">üì° <span id="dataTitle">Echtzeit-Daten</span></div>
            <div id="data-grid"></div>
        </div>
        
        <footer>v7.3 Complete Edition ‚Ä¢ 15+ Satellitendatenquellen</footer>
    </div>

    <script>
        const API = window.location.hostname === 'localhost' ? 'http://localhost:8000' : 'https://space-ai-alert-mvp.onrender.com';
        let currentData = null;
        let chatHistory = JSON.parse(localStorage.getItem('chat_history') || '[]');
        
        const T = {
            de: {
                subtitle: "Complete Edition - 15+ Satellitendatenquellen",
                inputsTitle: "Standort & Einstellungen", latLabel: "Breitengrad", lonLabel: "L√§ngengrad",
                profileLabel: "Profil", langLabel: "Sprache", btnGet: "Empfehlung holen", btnLoc: "Mein Standort",
                chatTitle: "KI-Assistent", clearChat: "Verlauf l√∂schen", btnSend: "Senden",
                dataTitle: "Echtzeit-Daten", loading: "Analysiere Daten...",
                Low: "Niedrig", Medium: "Mittel", High: "Hoch", Critical: "Kritisch", risk: "Risiko",
                Clear: "Klar", "Partly cloudy": "Teilweise bew√∂lkt", Overcast: "Bew√∂lkt", Cloudy: "Bew√∂lkt",
                Fog: "Nebel", Rain: "Regen", Snow: "Schnee", Thunderstorm: "Gewitter",
                good: "Gut", moderate: "M√§ssig", poor: "Schlecht", hazardous: "Gef√§hrlich",
                low: "Niedrig", high: "Hoch", none: "Keine",
                calm: "Ruhig", rough: "Rau", dangerous: "Gef√§hrlich",
                Quiet: "Ruhig", "Weak Storm": "Schwacher Sturm", "Moderate Storm": "Moderater Sturm",
                "Strong Storm": "Starker Sturm", "Severe Storm": "Schwerer Sturm",
                Yes: "Ja", No: "Nein", "None detected": "Keine", "No fires": "Keine",
                wildfires: "Waldbr√§nde", Earthquake: "Erdbeben", "Earth-directed CME": "CME Richtung Erde",
                "Forest fires in": "Waldbr√§nde in"
            },
            en: {
                subtitle: "Complete Edition - 15+ Satellite Data Sources",
                inputsTitle: "Location & Settings", latLabel: "Latitude", lonLabel: "Longitude",
                profileLabel: "Profile", langLabel: "Language", btnGet: "Get Recommendation", btnLoc: "My Location",
                chatTitle: "AI Assistant", clearChat: "Clear history", btnSend: "Send",
                dataTitle: "Real-time Data", loading: "Analyzing data...", risk: "Risk"
            },
            fr: {
                subtitle: "√âdition Compl√®te - 15+ Sources Satellitaires",
                inputsTitle: "Localisation", latLabel: "Latitude", lonLabel: "Longitude",
                profileLabel: "Profil", langLabel: "Langue", btnGet: "Obtenir", btnLoc: "Ma Position",
                chatTitle: "Assistant IA", clearChat: "Effacer", btnSend: "Envoyer",
                dataTitle: "Donn√©es Temps R√©el", loading: "Analyse...",
                Low: "Faible", Medium: "Moyen", High: "√âlev√©", Critical: "Critique", risk: "Risque",
                Yes: "Oui", No: "Non"
            },
            it: {
                subtitle: "Edizione Completa - 15+ Fonti Satellitari",
                inputsTitle: "Posizione", latLabel: "Latitudine", lonLabel: "Longitudine",
                profileLabel: "Profilo", langLabel: "Lingua", btnGet: "Ottieni", btnLoc: "Mia Posizione",
                chatTitle: "Assistente IA", clearChat: "Cancella", btnSend: "Invia",
                dataTitle: "Dati Tempo Reale", loading: "Analisi...",
                Low: "Basso", Medium: "Medio", High: "Alto", Critical: "Critico", risk: "Rischio",
                Yes: "S√¨", No: "No"
            }
        };
        
        const t = k => T[document.getElementById('language').value]?.[k] || T.de[k] || k;
        
        const translateFactor = f => {
            const lang = document.getElementById('language').value;
            const p = { de: { wildfires: 'Waldbr√§nde', Earthquake: 'Erdbeben', 'Earth-directed CME': 'CME Richtung Erde', 'Forest fires in': 'Waldbr√§nde in' },
                        fr: { wildfires: 'incendies', Earthquake: 'S√©isme', 'Forest fires in': 'Feux en' },
                        it: { wildfires: 'incendi', Earthquake: 'Terremoto', 'Forest fires in': 'Incendi in' } };
            let r = f;
            for (const [e, tr] of Object.entries(p[lang] || p.de || {})) r = r.replace(new RegExp(e, 'gi'), tr);
            return r;
        };
        
        const applyT = () => {
            ['subtitle','inputsTitle','latLabel','lonLabel','profileLabel','langLabel','btnGet','btnLoc','chatTitle','clearChat','btnSend','dataTitle'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.textContent = t(id);
            });
        };
        
        const changeLanguage = () => { applyT(); localStorage.setItem('lang', document.getElementById('language').value); if (currentData) { renderAI(currentData); renderData(currentData); } };
        
        const badge = (v, th) => v == null ? '' : v <= th[0] ? 'badge-good' : v <= th[1] ? 'badge-moderate' : 'badge-bad';
        const fmt = (v, u = '', d = 1) => v == null || v === 'N/A' ? 'N/A' : (typeof v === 'number' ? v.toFixed(d) + u : v + u);
        
        const renderChat = () => {
            const m = document.getElementById('chat-messages');
            m.innerHTML = chatHistory.map(c => c.role === 'user' ? `<div class="chat-message chat-user">üë§ ${c.text}</div>` : `<div class="chat-message chat-ai${c.initial ? ' chat-ai-initial' : ''}">ü§ñ ${c.text}</div>`).join('');
            m.scrollTop = m.scrollHeight;
        };
        
        const saveChat = () => { if (chatHistory.length > 20) chatHistory = chatHistory.slice(-20); localStorage.setItem('chat_history', JSON.stringify(chatHistory)); };
        const clearChat = () => { chatHistory = []; localStorage.removeItem('chat_history'); document.getElementById('chat-messages').innerHTML = ''; fetchInitial(); };
        
        const getInputs = () => ({ lat: document.getElementById('lat').value, lon: document.getElementById('lon').value, profile: document.getElementById('profile').value, lang: document.getElementById('language').value });
        
        const fetchInitial = async () => {
            const { lat, lon, profile, lang } = getInputs();
            const q = { de: 'Gib mir eine kurze Begr√ºssung und fasse die Umweltbedingungen zusammen.', en: 'Give me a brief greeting and summarize conditions.', fr: 'Donne-moi un r√©sum√© des conditions.', it: 'Dammi un riassunto delle condizioni.' }[lang] || 'Zusammenfassung bitte.';
            const ctx = chatHistory.length > 0 ? '\n\nBisherige Konversation:\n' + chatHistory.slice(-4).map(c => `${c.role === 'user' ? 'Nutzer' : 'KI'}: ${c.text}`).join('\n') : '';
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(profile)}&language=${lang}&question=${encodeURIComponent(q + ctx)}`, { method: 'POST' });
                const data = await res.json();
                chatHistory.push({ role: 'ai', text: data.answer, initial: true });
                saveChat(); renderChat();
            } catch (e) { console.error(e); }
        };
        
        async function fetchAlert() {
            const { lat, lon, profile, lang } = getInputs();
            document.getElementById('ai-container').innerHTML = `<div class="loading">${t('loading')}</div>`;
            document.getElementById('data-grid').innerHTML = '';
            try {
                const res = await fetch(`${API}/alert/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(profile)}&language=${lang}`);
                const data = await res.json();
                if (data.status === 'success') {
                    currentData = data;
                    renderAI(data);
                    renderData(data);
                    if (chatHistory.length === 0) fetchInitial();
                }
            } catch (e) { document.getElementById('ai-container').innerHTML = `<div class="loading">‚ùå ${e.message}</div>`; }
        }
        
        async function sendChat() {
            const input = document.getElementById('chat-input');
            const q = input.value.trim();
            if (!q) return;
            const { lat, lon, profile, lang } = getInputs();
            chatHistory.push({ role: 'user', text: q });
            saveChat(); renderChat(); input.value = '';
            const ctx = '\n\nKonversation:\n' + chatHistory.slice(-6).map(c => `${c.role === 'user' ? 'Nutzer' : 'KI'}: ${c.text}`).join('\n');
            const m = document.getElementById('chat-messages');
            const tid = 'typing' + Date.now();
            m.innerHTML += `<div class="chat-message chat-ai" id="${tid}">üí≠ ...</div>`;
            m.scrollTop = m.scrollHeight;
            try {
                const res = await fetch(`${API}/chat/?lat=${lat}&lon=${lon}&profile=${encodeURIComponent(profile)}&language=${lang}&question=${encodeURIComponent(q + ctx)}`, { method: 'POST' });
                const data = await res.json();
                document.getElementById(tid)?.remove();
                chatHistory.push({ role: 'ai', text: data.answer });
                saveChat(); renderChat();
            } catch (e) { document.getElementById(tid)?.remove(); chatHistory.push({ role: 'ai', text: '‚ùå ' + e.message }); saveChat(); renderChat(); }
        }
        
        function renderAI(data) {
            const rLvl = t(data.risk.level), rWord = t('risk');
            const rCls = { Low: 'risk-low', Medium: 'risk-medium', High: 'risk-high', Critical: 'risk-critical' }[data.risk.level] || 'risk-low';
            const factors = (data.risk.factors || []).map(f => translateFactor(f));
            const fHtml = factors.length ? `<div class="risk-factors">${factors.map(f => `<span class="risk-factor${f.includes('üî•') || f.includes('CME') ? ' severe' : ''}">${f}</span>`).join('')}</div>` : '';
            document.getElementById('ai-container').innerHTML = `<div class="ai-box"><div class="ai-recommendation">${data.recommendation}</div><div class="ai-meta"><span class="ai-source">üìç ${data.location.lat.toFixed(4)}, ${data.location.lon.toFixed(4)} ‚Ä¢ ${data.ai_source}</span><span class="risk-badge ${rCls}">${rLvl} ${rWord}</span></div>${fHtml}</div>`;
        }
        
        function renderData(data) {
            const d = data.data;
            document.getElementById('data-grid').innerHTML = `
                <div class="data-section-title">üå§Ô∏è Wetter & Luft</div>
                <div class="grid">
                    <div class="card"><div class="card-header"><span class="card-icon">üå§Ô∏è</span><span class="card-title">Wetter</span><span class="source-badge">ECMWF</span></div>
                        <div class="metric"><span class="metric-label">Temperatur</span><span class="metric-value">${fmt(d.weather?.temperature, '¬∞C')}</span></div>
                        <div class="metric"><span class="metric-label">Gef√ºhlt</span><span class="metric-value">${fmt(d.weather?.feels_like, '¬∞C')}</span></div>
                        <div class="metric"><span class="metric-label">Bedingungen</span><span class="metric-value">${t(d.weather?.weather) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Feuchtigkeit</span><span class="metric-value">${fmt(d.weather?.humidity, '%', 0)}</span></div>
                        <div class="metric"><span class="metric-label">Wind</span><span class="metric-value">${fmt(d.weather?.wind_speed, ' km/h', 0)}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üí®</span><span class="card-title">Luftqualit√§t</span><span class="source-badge">Sentinel-5P</span></div>
                        <div class="metric"><span class="metric-label">EU AQI</span><span class="metric-value"><span class="badge ${badge(d.air_quality?.eu_aqi, [40, 80])}">${d.air_quality?.eu_aqi || 'N/A'}</span></span></div>
                        <div class="metric"><span class="metric-label">PM2.5</span><span class="metric-value">${fmt(d.air_quality?.pm2_5, ' Œºg/m¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">PM10</span><span class="metric-value">${fmt(d.air_quality?.pm10, ' Œºg/m¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">NO‚ÇÇ</span><span class="metric-value">${fmt(d.air_quality?.no2, ' Œºg/m¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">O‚ÇÉ</span><span class="metric-value">${fmt(d.air_quality?.ozone, ' Œºg/m¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">SO‚ÇÇ</span><span class="metric-value">${fmt(d.air_quality?.so2, ' Œºg/m¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">CO</span><span class="metric-value">${fmt(d.air_quality?.co, ' Œºg/m¬≥', 0)}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">‚òÄÔ∏è</span><span class="card-title">UV & Solar</span><span class="source-badge">CAMS</span></div>
                        <div class="metric"><span class="metric-label">UV-Index</span><span class="metric-value"><span class="badge ${badge(d.air_quality?.uv_index, [3, 6])}">${fmt(d.air_quality?.uv_index, '')}</span></span></div>
                        <div class="metric"><span class="metric-label">Solar</span><span class="metric-value">${d.solar_radiation?.solar_potential || 'N/A'}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üå∏</span><span class="card-title">Pollen</span><span class="source-badge">Open-Meteo</span></div>
                        <div class="metric"><span class="metric-label">Gr√§ser</span><span class="metric-value">${t(d.pollen?.pollen?.grass?.level) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Birke</span><span class="metric-value">${t(d.pollen?.pollen?.birch?.level) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Erle</span><span class="metric-value">${t(d.pollen?.pollen?.alder?.level) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Ambrosia</span><span class="metric-value">${t(d.pollen?.pollen?.ragweed?.level) || 'N/A'}</span></div></div>
                </div>
                <div class="data-section-title">üåû Weltraumwetter</div>
                <div class="grid">
                    <div class="card"><div class="card-header"><span class="card-icon">üß≤</span><span class="card-title">Geomagnetisch</span><span class="source-badge">GOES/Kyoto</span></div>
                        <div class="metric"><span class="metric-label">Kp-Index</span><span class="metric-value"><span class="badge ${badge(d.space?.kp?.value, [4, 6])}">${fmt(d.space?.kp?.value, '')}</span></span></div>
                        <div class="metric"><span class="metric-label">Status</span><span class="metric-value">${t(d.space?.kp?.level) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Dst-Index</span><span class="metric-value">${fmt(d.space?.dst?.value, ' nT', 0)}</span></div>
                        <div class="metric"><span class="metric-label">Dst Status</span><span class="metric-value">${t(d.space?.dst?.level) || 'N/A'}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üí®</span><span class="card-title">Sonnenwind</span><span class="source-badge">DSCOVR</span></div>
                        <div class="metric"><span class="metric-label">Geschwindigkeit</span><span class="metric-value">${fmt(d.space?.solar_wind?.speed, ' km/s', 0)}</span></div>
                        <div class="metric"><span class="metric-label">Dichte</span><span class="metric-value">${fmt(d.space?.solar_wind?.density, ' p/cm¬≥')}</span></div>
                        <div class="metric"><span class="metric-label">Bz</span><span class="metric-value">${fmt(d.space?.solar_wind?.bz, ' nT')}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üåû</span><span class="card-title">Sonnenaktivit√§t</span><span class="source-badge">GOES</span></div>
                        <div class="metric"><span class="metric-label">X-Ray</span><span class="metric-value">${d.space?.xray?.level || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Proton</span><span class="metric-value">${d.space?.protons?.level || 'N/A'}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üî•</span><span class="card-title">NASA DONKI</span><span class="source-badge">NASA</span></div>
                        <div class="metric"><span class="metric-label">CMEs (7d)</span><span class="metric-value">${d.donki?.cme?.count || 0}</span></div>
                        <div class="metric"><span class="metric-label">CME ‚Üí Erde</span><span class="metric-value"><span class="badge ${d.donki?.cme?.earth_directed ? 'badge-bad' : 'badge-good'}">${d.donki?.cme?.earth_directed ? t('Yes') : t('No')}</span></span></div>
                        <div class="metric"><span class="metric-label">Flares</span><span class="metric-value">${d.donki?.flares?.count || 0} (${d.donki?.flares?.max_class || '-'})</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üåå</span><span class="card-title">Aurora</span><span class="source-badge">OVATION</span></div>
                        <div class="metric"><span class="metric-label">Wahrscheinlichkeit</span><span class="metric-value">${d.space?.aurora?.probability || 0}%</span></div>
                        <div class="metric"><span class="metric-label">Sichtbarkeit</span><span class="metric-value">${t(d.space?.aurora?.visibility) || 'N/A'}</span></div>
                        <div class="metric"><span class="metric-label">Kp aktuell</span><span class="metric-value">${fmt(d.space?.kp?.value, '')}</span></div></div>
                </div>
                <div class="data-section-title">‚ö†Ô∏è Gefahren</div>
                <div class="grid">
                    <div class="card"><div class="card-header"><span class="card-icon">üåç</span><span class="card-title">Erdbeben</span><span class="source-badge">USGS</span></div>
                        <div class="metric"><span class="metric-label">Anzahl (500km)</span><span class="metric-value">${d.earthquakes?.count || 0}</span></div>
                        <div class="metric"><span class="metric-label">Max. Magnitude</span><span class="metric-value">${d.earthquakes?.max_magnitude || t('None detected')}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üî•</span><span class="card-title">Waldbr√§nde</span><span class="source-badge">VIIRS</span></div>
                        <div class="metric"><span class="metric-label">Anzahl (100km)</span><span class="metric-value"><span class="badge ${d.wildfires?.count > 0 ? 'badge-bad' : 'badge-good'}">${d.wildfires?.count || 0}</span></span></div>
                        <div class="metric"><span class="metric-label">Status</span><span class="metric-value">${d.wildfires?.count > 0 ? d.wildfires?.fires?.[0]?.distance_km + 'km' : t('No fires')}</span></div></div>
                    <div class="card"><div class="card-header"><span class="card-icon">üö®</span><span class="card-title">Katastrophen</span><span class="source-badge">UN GDACS</span></div>
                        <div class="metric"><span class="metric-label">Warnungen</span><span class="metric-value"><span class="badge ${d.gdacs?.count > 0 ? 'badge-moderate' : 'badge-good'}">${d.gdacs?.count || 0}</span></span></div>
                        ${d.gdacs?.alerts?.slice(0,2).map(a => `<div class="metric"><span class="metric-label">${a.type}</span><span class="metric-value">${a.alert_level}</span></div>`).join('') || ''}</div>
                    <div class="card"><div class="card-header"><span class="card-icon">üåä</span><span class="card-title">Wasser</span><span class="source-badge">GloFAS</span></div>
                        <div class="metric"><span class="metric-label">Hochwasser</span><span class="metric-value"><span class="badge ${d.flood?.risk === 'high' ? 'badge-bad' : 'badge-good'}">${t(d.flood?.risk) || 'N/A'}</span></span></div>
                        <div class="metric"><span class="metric-label">Wellenh√∂he</span><span class="metric-value">${fmt(d.marine?.wave_height, ' m')}</span></div>
                        <div class="metric"><span class="metric-label">Seezustand</span><span class="metric-value">${t(d.marine?.conditions) || 'N/A'}</span></div></div>
                </div>`;
        }
        
        function useMyLocation() {
            if (navigator.geolocation) navigator.geolocation.getCurrentPosition(p => { document.getElementById('lat').value = p.coords.latitude.toFixed(4); document.getElementById('lon').value = p.coords.longitude.toFixed(4); fetchAlert(); }, e => alert('Fehler: ' + e.message));
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            const savedLang = localStorage.getItem('lang');
            if (savedLang) document.getElementById('language').value = savedLang;
            applyT(); renderChat(); fetchAlert();
        });
    </script>
</body>
</html>
